# Craft Integration Update Plan

Currently, the Craft integration conceptually targets the "Daily Note" but doesn't fully implement the push logic within the daily brief generation cycle, and only collects the connection URL and API key from the frontend. 

## Proposed Changes

### 1. [backend/services/craft_sync.py](file:///Users/oli/Desktop/CraftCanvas/backend/services/craft_sync.py)
- Modify [push_brief_to_craft](file:///Users/oli/Desktop/CraftCanvas/backend/services/craft_sync.py#16-70) to accept `target_type: str = "daily_note"` and `target_id: str = ""`.
- If `target_type == "daily_note"`, format the payload position as `{"date": brief.date.isoformat(), "position": "end"}` (existing behaviour).
- If `target_type == "specific_document"`, format the payload position as `{"pageId": target_id, "position": "end"}` if `target_id` is provided, otherwise `{"index": "end"}` to append to the document linked directly by the connection URL.

### 2. [backend/services/brief_generator.py](file:///Users/oli/Desktop/CraftCanvas/backend/services/brief_generator.py)
- At the bottom of [generate_brief](file:///Users/oli/Desktop/CraftCanvas/backend/services/brief_generator.py#262-395), implement the missing logic to fetch the Craft settings (`craft_api_url`, `craft_api_token`, `craft_target_type`, `craft_target_document_id`) from the [Settings](file:///Users/oli/Desktop/CraftCanvas/backend/config.py#13-57) table.
- Use these settings to actually invoke `await push_brief_to_craft(...)`.
- We'll need to import the [Settings](file:///Users/oli/Desktop/CraftCanvas/backend/config.py#13-57) model correctly: `from models.settings import Settings`.

### 3. [frontend/app/settings/page.tsx](file:///Users/oli/Desktop/CraftCanvas/frontend/app/settings/page.tsx)
- Add `craft_target_type` (default `'daily_note'`) and `craft_target_document_id` (default `''`) to [AppSettings](file:///Users/oli/Desktop/CraftCanvas/frontend/app/settings/page.tsx#40-57) interface and `DEFAULT_SETTINGS`.
- Add a UI section in the Craft tab to let users choose between "Daily Note" (default) and "Specific Document".
- If "Specific Document" is selected, show an input field for the Document ID.

### 4. [frontend/app/setup/page.tsx](file:///Users/oli/Desktop/CraftCanvas/frontend/app/setup/page.tsx)
- Add state variables for `craftTargetType` and `craftTargetId`.
- Update the UI in Step 4 under Craft to match the settings page, allowing users to configure this during setup.
- Include these new keys in the `settingsData` object sent to `/settings/bulk`.

## Verification Plan

### Automated Tests
- Since this relies on an external API (Craft), we'll do manual verification through the browser.

### Manual Verification
- We can manually create a mock user and brief in the database or trigger `/api/v1/briefs/generate` (if such endpoint exists) to observe if the correct arguments are constructed and passed to `httpx.AsyncClient().post`.
- Check that the frontend Setting UI successfully saves the new settings (`craft_target_type` and `craft_target_document_id`) by refreshing the page and checking the network payload.
- Verify the Onboarding flow sends the new payload properly.

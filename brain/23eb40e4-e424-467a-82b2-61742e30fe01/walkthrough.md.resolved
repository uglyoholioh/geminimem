# Timetable Weekly Insights Walkthrough

## Overview

The "Modules" legend at the bottom of the timetable page has been completely replaced with a more dynamic and actionable **Weekly Insights** section. This new section provides an at-a-glance summary of important statistics for the currently selected week.

## Changes Made

1. **Calculated Weekly Statistics (`weeklyInsights` useMemo Hook):**
   - We calculate 4 main data points from `weekData.slots`:
     - **Contact Hours:** The total duration (in hours and minutes) of all classes scheduled for the week.
     - **Busiest Day:** The specific day (e.g., "Monday") with the most scheduled contact time, along with the hours on that day.
     - **Skipped Classes:** The number of classes where the user has toggled attendance off (`is_attended === false`).
     - **Active Modules:** The count of unique modules that have at least one scheduled class during the week.

2. **Added Sleek UI Cards ([frontend/app/timetable/page.tsx](file:///Users/oli/Desktop/CraftCanvas/frontend/app/timetable/page.tsx)):**
   - The insights are displayed in a responsive grid of 4 cards at the bottom of the page.
   - The cards use styling from the design system, with a special state for "Skipped Classes". If the user skips a class, the "Skipped Classes" card turns slightly red (using the urgency color variable) to serve as a subtle warning.

## Verification

The code changes are mostly straightforward and depend primarily on `weekData.slots`.

- I recommend visually inspecting the timetable page by navigating through different weeks.
- Verify that the total contact hours appear accurate for a given week.
- Verify that toggling a class's attendance via the eye icon immediately updates the "Skipped Classes" counter. 

## Code Diff

```diff
```diff:page.tsx
'use client'

import { useEffect, useState, useRef, useMemo } from 'react'
import { api } from '@/lib/api'
import {
  ChevronLeft,
  ChevronRight,
  Upload,
  Clock,
  MapPin,
  LayoutGrid,
  Columns,
  CheckSquare,
  Link as LinkIcon,
  Eye,
  EyeOff,
  Coffee
} from 'lucide-react'
import { startOfWeek, addWeeks, format } from 'date-fns'

/* ─── Types ─────────────────────────────────────── */

interface TimetableSlot {
  id: number
  course_id: number | null
  module_code: string
  module_name: string
  lesson_type: string | null
  lesson_id: string | null
  venue: string | null
  day_of_week: number
  start_time: string
  end_time: string
  course_colour: string
  is_attended?: boolean
}

interface AcademicWeek {
  semester: number | null
  academic_year: string | null
  week: number | null
  raw_week: number | null
  label: string
  semester_start: string | null
}

interface WeekData {
  week_start: string
  week_end: string
  academic_week: AcademicWeek
  slots: TimetableSlot[]
  total_slots: number
}

interface WeekTask {
  id: number
  title: string
  status: string
  priority: string
  course_code: string | null
  course_colour: string | null
  due_date: string | null
  due_time: string | null
}

/* ─── Constants ─────────────────────────────────── */

const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'] as const
const FULL_DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] as const

/* ─── Helpers ───────────────────────────────────── */

const getClassTypeShort = (type: string | null): string => {
  if (!type) return 'CLS'
  const map: Record<string, string> = {
    lecture: 'LEC',
    tutorial: 'TUT',
    laboratory: 'LAB',
    lab: 'LAB',
    recitation: 'REC',
    seminar: 'SEM',
    'sectional teaching': 'SEC',
  }
  return map[type.toLowerCase()] || type.toUpperCase().slice(0, 3)
}

/** Desaturate a hex colour for use as block background. */
const getLowSatBg = (hex: string, isDark: boolean): string => {
  const r = parseInt(hex.slice(1, 3), 16) / 255
  const g = parseInt(hex.slice(3, 5), 16) / 255
  const b = parseInt(hex.slice(5, 7), 16) / 255

  const max = Math.max(r, g, b), min = Math.min(r, g, b)
  let h = 0
  const l = (max + min) / 2

  if (max !== min) {
    const d = max - min
    switch (max) {
      case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break
      case g: h = ((b - r) / d + 2) / 6; break
      case b: h = ((r - g) / d + 4) / 6; break
    }
  }

  return `hsl(${Math.round(h * 360)}, 22%, ${isDark ? 18 : 93}%)`
}

const getAccentBorder = (hex: string): string => {
  return hex || 'var(--accent)'
}

/* ─── Component ─────────────────────────────────── */

export default function TimetablePage() {
  const [weekData, setWeekData] = useState<WeekData | null>(null)
  const [loading, setLoading] = useState(true)
  const [currentWeekStart, setCurrentWeekStart] = useState(
    () => startOfWeek(new Date(), { weekStartsOn: 1 })
  )
  const [uploading, setUploading] = useState(false)
  const [nusmodsUrl, setNusmodsUrl] = useState('')
  const [viewMode, setViewMode] = useState<'horizontal' | 'vertical'>('horizontal')
  const [showTasks, setShowTasks] = useState(false)
  const [weekTasks, setWeekTasks] = useState<WeekTask[]>([])
  const fileRef = useRef<HTMLInputElement>(null)

  // Detect dark mode
  const [isDark, setIsDark] = useState(false)
  useEffect(() => {
    const check = () => setIsDark(document.documentElement.classList.contains('dark'))
    check()
    const obs = new MutationObserver(check)
    obs.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] })
    return () => obs.disconnect()
  }, [])

  const formatDateParam = (d: Date) => format(d, 'yyyy-MM-dd')

  const fetchWeek = async (monday: Date): Promise<WeekData | null> => {
    try {
      setLoading(true)
      const data = await api.get('/timetable/week', { date: formatDateParam(monday) })
      setWeekData(data)
      return data
    } catch (err) {
      console.error('Failed to fetch timetable:', err)
      return null
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchWeek(currentWeekStart)
  }, [currentWeekStart])

  // Fetch tasks for the week when showTasks is enabled
  useEffect(() => {
    if (!showTasks) { setWeekTasks([]); return }
    const monday = currentWeekStart
    const sunday = new Date(monday)
    sunday.setDate(sunday.getDate() + 6)
    api.get('/tasks', {
      due_after: formatDateParam(monday),
      due_before: formatDateParam(sunday),
    }).then(data => setWeekTasks((data.tasks || []).filter((t: WeekTask) => t.due_date && t.status !== 'completed')))
      .catch(() => setWeekTasks([]))
  }, [showTasks, currentWeekStart])

  // Load and save settings
  useEffect(() => {
    api.get('/settings/show_tasks_on_timetable')
      .then(res => setShowTasks(res.value === 'true'))
      .catch(() => { })
  }, [])

  const toggleShowTasks = () => {
    const next = !showTasks
    setShowTasks(next)
    api.put('/settings/show_tasks_on_timetable', { value: next ? 'true' : 'false' }).catch(() => { })
  }

  // Helper: get tasks for a specific day
  const getTasksForDay = (dayIdx: number): WeekTask[] => {
    if (!showTasks || weekTasks.length === 0) return []
    const d = new Date(currentWeekStart)
    d.setDate(d.getDate() + dayIdx)
    const dateStr = formatDateParam(d)
    return weekTasks.filter(t => t.due_date === dateStr)
  }

  /* ─── Week navigation ─── */
  const goToPrev = () => setCurrentWeekStart(addWeeks(currentWeekStart, -1))
  const goToNext = () => setCurrentWeekStart(addWeeks(currentWeekStart, 1))
  const goToToday = () => setCurrentWeekStart(startOfWeek(new Date(), { weekStartsOn: 1 }))

  const handleToggleAttendance = async (slotId: number, currentStatus: boolean, e: React.MouseEvent) => {
    e.stopPropagation()
    const nextStatus = !currentStatus

    // Optimistic update
    setWeekData(prev => {
      if (!prev) return prev
      return {
        ...prev,
        slots: prev.slots.map(s => s.id === slotId ? { ...s, is_attended: nextStatus } : s)
      }
    })

    try {
      await api.patch(`/timetable/slots/${slotId}?is_attended=${nextStatus}`)
    } catch (err) {
      console.error('Failed to toggle attendance:', err)
      // Revert on error
      setWeekData(prev => {
        if (!prev) return prev
        return {
          ...prev,
          slots: prev.slots.map(s => s.id === slotId ? { ...s, is_attended: currentStatus } : s)
        }
      })
    }
  }

  /* ─── ICS import ─── */
  /** After import, jump to the nearest teaching week if currently in a non-teaching period. */
  const navigateToTeachingWeek = (data: WeekData | null) => {
    if (!data) return
    const label = data.academic_week?.label || ''
    const isNonTeaching = ['Recess Week', 'Reading Week', 'Vacation', 'Before Semester', 'Outside Semester'].includes(label)
      || label.startsWith('Exam Week')
    if (isNonTeaching) {
      const semStart = data.academic_week?.semester_start
      if (semStart) {
        // Go to week 1 of the semester
        const semMonday = startOfWeek(new Date(semStart), { weekStartsOn: 1 })
        setCurrentWeekStart(semMonday)
        return
      }
      // Fallback: jump forward 1 week
      setCurrentWeekStart(addWeeks(currentWeekStart, 1))
    }
  }

  const timeSlots = useMemo(() => {
    const slots = weekData?.slots || []
    if (slots.length === 0) {
      // Return a reasonable default block (08:00 - 18:00)
      return Array.from({ length: 11 }, (_, i) => `${(i + 8).toString().padStart(2, '0')}:00`)
    }

    let minH = 24
    let maxH = 0

    slots.forEach(s => {
      const sH = parseInt(s.start_time.split(':')[0])
      const [eHStr, eMStr] = s.end_time.split(':')
      let eH = parseInt(eHStr)
      if (parseInt(eMStr || '0') > 0) eH += 1

      if (sH < minH) minH = sH
      if (eH > maxH) maxH = eH
    })

    // Safety fallback
    if (minH >= maxH) {
      return Array.from({ length: 11 }, (_, i) => `${(i + 8).toString().padStart(2, '0')}:00`)
    }

    return Array.from({ length: maxH - minH }, (_, i) => `${(i + minH).toString().padStart(2, '0')}:00`)
  }, [weekData])

  const handleUrlImport = async () => {
    if (!nusmodsUrl) return
    setUploading(true)
    try {
      await api.post(`/timetable/import-url?url=${encodeURIComponent(nusmodsUrl)}`)
      setNusmodsUrl('')
      const data = await fetchWeek(currentWeekStart)
      navigateToTeachingWeek(data)
    } catch (err: any) {
      console.error('URL import failed:', err)
      alert(`Import failed: ${err.message || 'Make sure the URL is a valid NUSMods share link.'}`)
    } finally {
      setUploading(false)
    }
  }

  const handleImport = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return
    setUploading(true)
    try {
      const formData = new FormData()
      formData.append('file', file)
      await api.upload('/timetable/import', formData)
      const data = await fetchWeek(currentWeekStart)
      navigateToTeachingWeek(data)
    } catch (err: any) {
      console.error('Import failed:', err)
      alert(`Import failed: ${err.message || 'Make sure the file is a valid NUSMods .ics export.'}`)
    } finally {
      setUploading(false)
      if (fileRef.current) fileRef.current.value = ''
    }
  }

  /* ─── Grid cell helpers ─── */
  const getCellData = (dayIdx: number, timeSlot: string) => {
    if (!weekData) return { slotStart: null, isSpanned: false }
    const currentHour = parseInt(timeSlot.split(':')[0])

    const slotStart = weekData.slots.find((s) => {
      if (s.day_of_week !== dayIdx) return false
      const sH = parseInt(s.start_time.split(':')[0])
      return sH === currentHour
    })

    const isSpanned = !slotStart && weekData.slots.some((s) => {
      if (s.day_of_week !== dayIdx) return false
      const sH = parseInt(s.start_time.split(':')[0])
      const [eHStr, eMStr] = s.end_time.split(':')
      let eH = parseInt(eHStr)
      if (parseInt(eMStr || '0') > 0) eH += 1
      return currentHour > sH && currentHour < eH
    })

    return { slotStart: slotStart || null, isSpanned }
  }

  const getColOrRowSpan = (slot: TimetableSlot) => {
    const sH = parseInt(slot.start_time.split(':')[0])
    const [eHStr, eMStr] = slot.end_time.split(':')
    let eH = parseInt(eHStr)
    if (parseInt(eMStr || '0') > 0) eH += 1
    return Math.max(1, eH - sH)
  }

  /* ─── Unique modules for legend ─── */
  const uniqueModules = useMemo(() => {
    if (!weekData) return []
    const seen = new Map<string, { code: string; name: string; colour: string }>()
    for (const s of weekData.slots) {
      if (!seen.has(s.module_code)) {
        seen.set(s.module_code, {
          code: s.module_code,
          name: s.module_name || '',
          colour: s.course_colour,
        })
      }
    }
    return Array.from(seen.values()).sort((a, b) => a.code.localeCompare(b.code))
  }, [weekData])

  const todayDow = new Date().getDay() // 0=Sunday
  const weekEnd = new Date(currentWeekStart)
  weekEnd.setDate(weekEnd.getDate() + 6)

  const academicLabel = weekData?.academic_week?.label || ''
  const semLabel = weekData?.academic_week?.academic_year
    ? `Sem ${weekData.academic_week.semester} · AY${weekData.academic_week.academic_year}`
    : ''

  return (
    <div className="p-4 md:p-6 w-full mx-auto">
      {/* ─── Header ─── */}
      <header className="border-b-2 border-primary/20 pb-3 mb-4">
        <div className="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
          {/* Title cluster */}
          <div className="flex items-center gap-2 md:gap-3 flex-wrap">
            <span
              className="h-[2px] w-8 hidden md:block"
              style={{ background: 'var(--urgency, #C4836A)' }}
            />
            <h1 className="font-serif text-2xl md:text-3xl text-primary leading-none">
              {academicLabel || 'Timetable'}
            </h1>
            {semLabel && (
              <>
                <span className="text-muted font-mono text-xs hidden sm:inline">•</span>
                <span className="font-mono text-xs text-secondary">{semLabel}</span>
              </>
            )}
            <span className="text-muted font-mono text-xs hidden sm:inline">•</span>
            <span className="font-serif text-sm text-secondary italic">
              {format(currentWeekStart, 'MMM d')} — {format(weekEnd, 'MMM d')}
            </span>
          </div>

          {/* Controls */}
          <div className="flex items-center gap-2 flex-wrap">
            {/* Show Tasks Toggle */}
            <div className="flex items-center border border-border bg-surface mr-2 rounded-sm overflow-hidden h-9">
              <button
                onClick={toggleShowTasks}
                title={showTasks ? 'Hide Tasks' : 'Show Tasks'}
                className={`h-full flex items-center gap-1.5 px-3 transition-colors ${showTasks ? 'bg-primary/10 text-primary' : 'text-muted hover:bg-surface-hover'}`}
              >
                <CheckSquare className="w-4 h-4" />
                <span className="text-xs font-mono font-medium hidden sm:inline">Tasks</span>
              </button>
            </div>

            {/* View Toggle */}
            <div className="flex items-center border border-border bg-surface mr-2 rounded-sm overflow-hidden h-9">
              <button
                onClick={() => setViewMode('horizontal')}
                title="Horizontal View (Days on Y, Time on X)"
                className={`w-10 h-full flex items-center justify-center transition-colors ${viewMode === 'horizontal' ? 'bg-primary/10 text-primary' : 'text-muted hover:bg-surface-hover'
                  }`}
              >
                <LayoutGrid className="w-4 h-4" />
              </button>
              <div className="w-px h-6 bg-border" />
              <button
                onClick={() => setViewMode('vertical')}
                title="Vertical View (Time on Y, Days on X)"
                className={`w-10 h-full flex items-center justify-center transition-colors ${viewMode === 'vertical' ? 'bg-primary/10 text-primary' : 'text-muted hover:bg-surface-hover'
                  }`}
              >
                <Columns className="w-4 h-4" />
              </button>
            </div>

            <button
              onClick={goToPrev}
              className="h-9 w-9 flex items-center justify-center border border-border bg-surface hover:bg-surface-hover transition-colors rounded-sm"
            >
              <ChevronLeft className="h-4 w-4 text-secondary" />
            </button>
            <button
              onClick={goToToday}
              className="px-4 h-9 border border-border bg-surface text-xs font-mono font-medium uppercase tracking-widest text-primary hover:bg-surface-hover transition-colors rounded-sm"
            >
              Today
            </button>
            <button
              onClick={goToNext}
              className="h-9 w-9 flex items-center justify-center border border-border bg-surface hover:bg-surface-hover transition-colors rounded-sm"
            >
              <ChevronRight className="h-4 w-4 text-secondary" />
            </button>

            <div className="w-px h-6 bg-border mx-1 hidden sm:block" />

            <label className="cursor-pointer hidden sm:block">
              <input
                type="file"
                accept=".ics"
                className="hidden"
                onChange={handleImport}
                ref={fileRef}
              />
              <span className="flex items-center gap-1.5 px-3 h-9 text-xs font-mono font-medium border border-border bg-surface text-secondary hover:bg-surface-hover transition-colors rounded-sm">
                <Upload className="h-3.5 w-3.5" />
                {uploading ? '…' : 'ICS'}
              </span>
            </label>

            <div className="flex items-center border border-border bg-surface ml-2 rounded-sm overflow-hidden h-9 hidden xl:flex">
              <input
                type="text"
                placeholder="Paste NUSMods URL..."
                value={nusmodsUrl}
                onChange={(e) => setNusmodsUrl(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleUrlImport()}
                className="bg-transparent border-none text-xs font-mono h-full px-3 w-48 focus:ring-0 placeholder:text-muted"
              />
              <button
                onClick={handleUrlImport}
                disabled={!nusmodsUrl || uploading}
                title="Import from NUSMods URL"
                className="h-full px-3 text-secondary hover:bg-surface-hover transition-colors border-l border-border disabled:opacity-50"
              >
                {uploading ? (
                  <span className="animate-spin text-[10px]">◌</span>
                ) : (
                  <LinkIcon className="w-3.5 h-3.5" />
                )}
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* ─── Grid ─── */}
      {loading ? (
        <div className="flex items-center justify-center h-96">
          <span className="text-muted text-xs font-mono uppercase tracking-widest">
            Loading timetable…
          </span>
        </div>
      ) : !weekData || (weekData.slots.length === 0 && (weekData.total_slots ?? 0) === 0) ? (
        <div className="border border-border bg-surface p-12 text-center rounded-sm">
          <p className="font-serif text-lg text-primary mb-2">No class schedules yet</p>
          <p className="font-mono text-xs text-muted mb-6">
            Import your NUSMods .ics file to get started
          </p>
          <button
            onClick={() => fileRef.current?.click()}
            className="px-5 py-2.5 border border-border bg-surface text-xs font-mono font-medium uppercase tracking-widest text-primary hover:bg-surface-hover transition-colors rounded-sm"
          >
            <Upload size={14} className="inline mr-2 -mt-0.5" />
            Import Timetable
          </button>
        </div>
      ) : weekData.slots.length === 0 ? (
        /* Slots are imported but none this week (recess/vacation/reading week) */
        <div className="border border-border bg-surface rounded-sm">
          <div className="flex flex-col items-center justify-center py-16 px-6 text-center">
            <Coffee className="h-10 w-10 text-muted mb-4" strokeWidth={1.5} />
            <p className="font-serif text-lg text-primary mb-1.5">
              {weekData.academic_week?.label || 'No Classes This Week'}
            </p>
            <p className="font-mono text-xs text-muted max-w-xs">
              {weekData.academic_week?.label === 'Recess Week'
                ? 'Enjoy your break! Classes resume next week.'
                : weekData.academic_week?.label === 'Reading Week'
                  ? 'Reading week — time to catch up and revise.'
                  : weekData.academic_week?.label?.startsWith('Exam Week')
                    ? 'Exam period — good luck!'
                    : 'No classes scheduled for this week.'}
            </p>
            <p className="font-mono text-[10px] text-muted mt-3">
              {weekData.total_slots} class{weekData.total_slots !== 1 ? 'es' : ''} imported · navigate to a teaching week to view
            </p>
          </div>
        </div>
      ) : (
        <div className="border border-border bg-surface overflow-hidden rounded-sm">
          <div className="overflow-x-auto">
            {viewMode === 'vertical' ? (
              /* ========================================= */
              /* VERTICAL VIEW (Time on Y, Days on X)      */
              /* ========================================= */
              <table className="w-full border-collapse" style={{ minWidth: 700 }}>
                {/* ─── Header row ─── */}
                <thead>
                  <tr>
                    <th
                      className="p-3 text-center font-mono text-xs font-medium uppercase tracking-wider text-muted border-b border-border border-r border-border bg-base"
                      style={{ width: 64 }}
                    >
                      Time
                    </th>
                    {DAYS.map((day, i) => {
                      const isToday = todayDow === i + 1
                      return (
                        <th
                          key={day}
                          className={`p-3 text-center border-b border-border border-r border-border last:border-r-0 ${isToday ? 'bg-accent-subtle' : 'bg-base'
                            }`}
                          style={{ minWidth: 130 }}
                        >
                          <div className={`font-mono text-xs font-medium uppercase tracking-widest ${isToday ? 'text-accent' : 'text-muted'
                            }`}>
                            {day}
                          </div>
                          <div className={`font-serif text-sm italic mt-0.5 ${isToday ? 'text-accent' : 'text-secondary'
                            }`}>
                            {(() => {
                              const d = new Date(currentWeekStart)
                              d.setDate(d.getDate() + i)
                              return format(d, 'MMM d')
                            })()}
                          </div>
                        </th>
                      )
                    })}
                  </tr>
                </thead>

                {/* ─── Time rows ─── */}
                <tbody>
                  {timeSlots.map((time, timeIdx) => {
                    return (
                      <tr key={time}>
                        {/* Time label */}
                        <td
                          className="p-2 text-center font-mono text-[10px] text-muted align-top border-r border-border-subtle bg-base"
                          style={{ height: 64 }}
                        >
                          {time}
                        </td>

                        {/* Day columns */}
                        {DAYS.map((_, dayIdx) => {
                          const { slotStart, isSpanned } = getCellData(dayIdx, time)
                          const isToday = todayDow === dayIdx + 1

                          // Cell is part of a spanning slot — skip (rowSpan handles it)
                          if (isSpanned) return null

                          // Empty cell
                          if (!slotStart) {
                            return (
                              <td
                                key={`${dayIdx}-${time}`}
                                className={`border-r border-border-subtle last:border-r-0 border-b border-border-subtle ${isToday ? 'bg-accent-subtle/30' : ''
                                  }`}
                                style={{
                                  height: 64,
                                  backgroundColor: !isToday
                                    ? timeIdx % 2 === 0
                                      ? 'rgba(0,0,0,0.01)'
                                      : 'transparent'
                                    : undefined,
                                }}
                              />
                            )
                          }

                          // Slot starts here — render with rowSpan
                          const rowSpan = getColOrRowSpan(slotStart)
                          const moduleColor = slotStart.course_colour || '#7C8C6E'
                          const bgColor = getLowSatBg(moduleColor, isDark)
                          const typeShort = getClassTypeShort(slotStart.lesson_type)

                          return (
                            <td
                              key={`${dayIdx}-${time}`}
                              className="align-top p-0 border-r border-border-subtle last:border-r-0 border-b border-border-subtle"
                              style={{ height: rowSpan * 64 }}
                              rowSpan={rowSpan}
                            >
                              <div
                                className={`group h-full mx-0.5 my-0.5 rounded-sm p-2.5 overflow-hidden flex flex-col gap-1 transition-all hover:brightness-110 shadow-sm ${slotStart.is_attended === false ? 'opacity-40 grayscale-[0.8]' : ''}`}
                                style={{
                                  backgroundColor: bgColor,
                                  borderLeft: `3px solid ${getAccentBorder(moduleColor)}`,
                                }}
                              >
                                <div className="flex items-center justify-between gap-1.5 flex-wrap w-full">
                                  <div className="flex items-center gap-1.5 flex-wrap">
                                    <span className="font-mono text-xs font-bold" style={{ color: moduleColor }}>
                                      {slotStart.module_code}
                                    </span>
                                    <span
                                      className="font-mono text-[9px] font-medium px-1.5 py-0.5 rounded-sm whitespace-nowrap"
                                      style={{
                                        backgroundColor: `${moduleColor}20`,
                                        color: moduleColor,
                                      }}
                                    >
                                      {typeShort}
                                      {slotStart.lesson_id ? ` [${slotStart.lesson_id}]` : ''}
                                    </span>
                                  </div>
                                  <button
                                    onClick={(e) => handleToggleAttendance(slotStart.id, slotStart.is_attended ?? true, e)}
                                    className={`h-5 w-5 rounded-md flex items-center justify-center shrink-0 transition-colors ${slotStart.is_attended !== false
                                      ? 'text-muted hover:text-primary hover:bg-black/5 opacity-0 group-hover:opacity-100'
                                      : 'text-muted bg-black/10 hover:bg-black/20 opacity-100'
                                      }`}
                                    title={slotStart.is_attended !== false ? "Mark as unattended" : "Mark as attended"}
                                  >
                                    {slotStart.is_attended !== false ? <Eye className="h-3 w-3" /> : <EyeOff className="h-3 w-3" />}
                                  </button>
                                </div>

                                {/* Module name */}
                                {slotStart.module_name && (
                                  <div className="text-[11px] text-secondary leading-tight line-clamp-2">
                                    {slotStart.module_name}
                                  </div>
                                )}

                                <div className="mt-auto pt-1 flex flex-col gap-0.5">
                                  {/* Time */}
                                  <div className="flex items-center gap-1 text-[10px] text-muted">
                                    <Clock size={10} strokeWidth={2} className="flex-shrink-0" />
                                    <span className="truncate">
                                      {slotStart.start_time} – {slotStart.end_time}
                                    </span>
                                  </div>

                                  {/* Venue */}
                                  {slotStart.venue && (
                                    <div className="flex items-center gap-1 text-[10px] text-muted">
                                      <MapPin size={10} strokeWidth={2} className="flex-shrink-0" />
                                      <span className="truncate">{slotStart.venue}</span>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </td>
                          )
                        })}
                      </tr>
                    )
                  })}
                </tbody>

                {/* ─── Task row (bottom of vertical grid) ─── */}
                {showTasks && weekTasks.length > 0 && (
                  <tfoot>
                    <tr>
                      <td className="p-2 text-center font-mono text-[10px] text-muted align-top border-r border-border-subtle bg-base border-t border-border" style={{ height: 'auto' }}>
                        Tasks
                      </td>
                      {DAYS.map((_, dayIdx) => {
                        const dayTasks = getTasksForDay(dayIdx)
                        return (
                          <td key={`tasks-${dayIdx}`} className="p-1.5 align-top border-r border-border-subtle last:border-r-0 border-t border-border" style={{ minHeight: 40 }}>
                            {dayTasks.length > 0 ? (
                              <div className="space-y-1">
                                {dayTasks.map(t => (
                                  <div
                                    key={t.id}
                                    className="rounded-sm px-2 py-1.5 text-[10px] leading-tight truncate"
                                    style={{
                                      backgroundColor: t.priority === 'urgent' || t.priority === 'high'
                                        ? 'var(--urgency-subtle)'
                                        : 'var(--accent-subtle)',
                                      borderLeft: `2px solid ${t.priority === 'urgent' || t.priority === 'high' ? 'var(--urgency)' : 'var(--accent)'}`,
                                      color: t.priority === 'urgent' || t.priority === 'high'
                                        ? 'var(--urgency)'
                                        : 'var(--accent)',
                                    }}
                                  >
                                    <span className="font-medium">{t.title}</span>
                                    {t.due_time && (
                                      <span className="ml-1 opacity-70 font-mono">{t.due_time.slice(0, 5)}</span>
                                    )}
                                  </div>
                                ))}
                              </div>
                            ) : null}
                          </td>
                        )
                      })}
                    </tr>
                  </tfoot>
                )}
              </table>
            ) : (
              /* ========================================= */
              /* HORIZONTAL VIEW (Days on Y, Time on X)    */
              /* ========================================= */
              <table className="w-full border-collapse table-fixed" style={{ minWidth: 1000 }}>
                {/* ─── Header row (Times) ─── */}
                <thead>
                  <tr>
                    <th
                      className="p-3 text-center font-mono text-xs font-medium uppercase tracking-wider text-muted border-b border-border border-r border-border bg-base w-24 sticky left-0 z-10"
                    >
                      Day
                    </th>
                    {timeSlots.map((time) => (
                      <th
                        key={time}
                        className="p-2 text-left font-mono text-[10px] text-muted border-b border-border border-r border-border-subtle bg-base w-32"
                      >
                        {time}
                      </th>
                    ))}
                  </tr>
                </thead>

                {/* ─── Day rows ─── */}
                <tbody>
                  {DAYS.map((day, dayIdx) => {
                    const isToday = todayDow === dayIdx + 1

                    return (
                      <tr key={day} className={isToday ? 'bg-accent-subtle/10' : ''}>
                        {/* Day label */}
                        <td
                          className={`p-3 border-r border-border border-b border-border-subtle sticky left-0 z-10 ${isToday ? 'bg-accent-subtle/30' : 'bg-base'
                            }`}
                        >
                          <div className={`font-mono text-xs font-medium uppercase tracking-widest ${isToday ? 'text-accent' : 'text-muted'
                            }`}>
                            {day}
                          </div>
                          <div className={`font-serif text-sm italic mt-0.5 ${isToday ? 'text-accent' : 'text-secondary'
                            }`}>
                            {(() => {
                              const d = new Date(currentWeekStart)
                              d.setDate(d.getDate() + dayIdx)
                              return format(d, 'MMM d')
                            })()}
                          </div>

                          {/* Task pills under day label */}
                          {showTasks && (() => {
                            const dayTasks = getTasksForDay(dayIdx)
                            if (dayTasks.length === 0) return null
                            return (
                              <div className="mt-1.5 space-y-0.5">
                                {dayTasks.slice(0, 3).map(t => (
                                  <div
                                    key={t.id}
                                    className="rounded-sm px-1.5 py-0.5 text-[9px] leading-tight truncate max-w-full"
                                    style={{
                                      backgroundColor: t.priority === 'urgent' || t.priority === 'high'
                                        ? 'var(--urgency-subtle)'
                                        : 'var(--accent-subtle)',
                                      borderLeft: `2px solid ${t.priority === 'urgent' || t.priority === 'high' ? 'var(--urgency)' : 'var(--accent)'}`,
                                      color: t.priority === 'urgent' || t.priority === 'high'
                                        ? 'var(--urgency)'
                                        : 'var(--accent)',
                                    }}
                                  >
                                    {t.title}
                                  </div>
                                ))}
                                {dayTasks.length > 3 && (
                                  <div className="text-[8px] text-muted font-mono">+{dayTasks.length - 3} more</div>
                                )}
                              </div>
                            )
                          })()}
                        </td>

                        {/* Time columns */}
                        {timeSlots.map((time, timeIdx) => {
                          const { slotStart, isSpanned } = getCellData(dayIdx, time)

                          // Cell is part of a spanning slot — skip (colSpan handles it)
                          if (isSpanned) return null

                          // Empty cell
                          if (!slotStart) {
                            return (
                              <td
                                key={`${day}-${time}`}
                                className={`border-r border-border-subtle border-b border-border-subtle h-[110px] ${isToday ? 'border-r-accent-subtle/50' : ''}`}
                                style={{
                                  backgroundColor: !isToday
                                    ? timeIdx % 2 === 0
                                      ? 'rgba(0,0,0,0.01)'
                                      : 'transparent'
                                    : undefined,
                                }}
                              />
                            )
                          }

                          // Slot starts here — render with colSpan
                          const colSpan = getColOrRowSpan(slotStart)
                          const moduleColor = slotStart.course_colour || '#7C8C6E'
                          const bgColor = getLowSatBg(moduleColor, isDark)
                          const typeShort = getClassTypeShort(slotStart.lesson_type)

                          return (
                            <td
                              key={`${day}-${time}`}
                              className="p-1 border-r border-border-subtle border-b border-border-subtle align-top h-[110px]"
                              colSpan={colSpan}
                            >
                              <div
                                className={`group h-full rounded-sm p-2.5 overflow-hidden flex flex-col gap-1 transition-all hover:brightness-110 shadow-sm ${slotStart.is_attended === false ? 'opacity-40 grayscale-[0.8]' : ''}`}
                                style={{
                                  backgroundColor: bgColor,
                                  borderLeft: `3px solid ${getAccentBorder(moduleColor)}`,
                                }}
                              >
                                <div className="flex items-center justify-between gap-1 flex-wrap">
                                  <div className="flex items-center gap-1.5 flex-wrap">
                                    <span className="font-mono text-xs font-bold" style={{ color: moduleColor }}>
                                      {slotStart.module_code}
                                    </span>
                                    <span
                                      className="font-mono text-[9px] font-medium px-1.5 py-0.5 rounded-sm whitespace-nowrap"
                                      style={{
                                        backgroundColor: `${moduleColor}20`,
                                        color: moduleColor,
                                      }}
                                    >
                                      {typeShort}
                                      {slotStart.lesson_id ? ` [${slotStart.lesson_id}]` : ''}
                                    </span>
                                  </div>
                                  <button
                                    onClick={(e) => handleToggleAttendance(slotStart.id, slotStart.is_attended ?? true, e)}
                                    className={`h-5 w-5 rounded-md flex items-center justify-center shrink-0 transition-colors ${slotStart.is_attended !== false
                                      ? 'text-muted hover:text-primary hover:bg-black/5 opacity-0 group-hover:opacity-100'
                                      : 'text-muted bg-black/10 hover:bg-black/20 opacity-100'
                                      }`}
                                    title={slotStart.is_attended !== false ? "Mark as unattended" : "Mark as attended"}
                                  >
                                    {slotStart.is_attended !== false ? <Eye className="h-3 w-3" /> : <EyeOff className="h-3 w-3" />}
                                  </button>
                                </div>

                                {slotStart.module_name && colSpan > 1 && (
                                  <div className="text-[11px] text-secondary leading-tight line-clamp-1 truncate">
                                    {slotStart.module_name}
                                  </div>
                                )}

                                <div className="mt-auto pt-1 flex items-center justify-between gap-2 overflow-hidden flex-wrap shrink-0">
                                  <div className="flex items-center gap-1 text-[10px] text-muted">
                                    <Clock size={10} strokeWidth={2} className="flex-shrink-0" />
                                    <span className="truncate">
                                      {slotStart.start_time} – {slotStart.end_time}
                                    </span>
                                  </div>

                                  {slotStart.venue && colSpan > 1 && (
                                    <div className="flex items-center gap-1 text-[10px] text-muted">
                                      <MapPin size={10} strokeWidth={2} className="flex-shrink-0" />
                                      <span className="truncate">{slotStart.venue}</span>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </td>
                          )
                        })}
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            )}
          </div>
        </div>
      )}

      {/* ─── Module Legend ─── */}
      {uniqueModules.length > 0 && (
        <div className="mt-4 border border-border bg-surface p-4 rounded-sm">
          <div className="font-mono text-[10px] text-muted uppercase tracking-widest mb-3">
            Modules
          </div>
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
            {uniqueModules.map((mod) => (
              <div key={mod.code} className="flex items-center gap-2.5">
                <div
                  className="w-3 h-3 rounded-sm flex-shrink-0 shadow-inner"
                  style={{ backgroundColor: mod.colour }}
                />
                <div className="min-w-0 flex flex-col">
                  <span
                    className="font-mono text-xs font-bold leading-none mb-0.5"
                    style={{ color: mod.colour }}
                  >
                    {mod.code}
                  </span>
                  {mod.name && (
                    <span className="text-[10px] text-secondary leading-tight truncate">
                      {mod.name}
                    </span>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}
===
'use client'

import { useEffect, useState, useRef, useMemo } from 'react'
import { api } from '@/lib/api'
import {
  ChevronLeft,
  ChevronRight,
  Upload,
  Clock,
  MapPin,
  LayoutGrid,
  Columns,
  CheckSquare,
  Link as LinkIcon,
  Eye,
  EyeOff,
  Coffee,
  CalendarDays,
  Activity,
  AlertCircle,
  BookOpen
} from 'lucide-react'
import { startOfWeek, addWeeks, format } from 'date-fns'

/* ─── Types ─────────────────────────────────────── */

interface TimetableSlot {
  id: number
  course_id: number | null
  module_code: string
  module_name: string
  lesson_type: string | null
  lesson_id: string | null
  venue: string | null
  day_of_week: number
  start_time: string
  end_time: string
  course_colour: string
  is_attended?: boolean
}

interface AcademicWeek {
  semester: number | null
  academic_year: string | null
  week: number | null
  raw_week: number | null
  label: string
  semester_start: string | null
}

interface WeekData {
  week_start: string
  week_end: string
  academic_week: AcademicWeek
  slots: TimetableSlot[]
  total_slots: number
}

interface WeekTask {
  id: number
  title: string
  status: string
  priority: string
  course_code: string | null
  course_colour: string | null
  due_date: string | null
  due_time: string | null
}

/* ─── Constants ─────────────────────────────────── */

const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'] as const
const FULL_DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] as const

/* ─── Helpers ───────────────────────────────────── */

const getClassTypeShort = (type: string | null): string => {
  if (!type) return 'CLS'
  const map: Record<string, string> = {
    lecture: 'LEC',
    tutorial: 'TUT',
    laboratory: 'LAB',
    lab: 'LAB',
    recitation: 'REC',
    seminar: 'SEM',
    'sectional teaching': 'SEC',
  }
  return map[type.toLowerCase()] || type.toUpperCase().slice(0, 3)
}

/** Desaturate a hex colour for use as block background. */
const getLowSatBg = (hex: string, isDark: boolean): string => {
  const r = parseInt(hex.slice(1, 3), 16) / 255
  const g = parseInt(hex.slice(3, 5), 16) / 255
  const b = parseInt(hex.slice(5, 7), 16) / 255

  const max = Math.max(r, g, b), min = Math.min(r, g, b)
  let h = 0
  const l = (max + min) / 2

  if (max !== min) {
    const d = max - min
    switch (max) {
      case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break
      case g: h = ((b - r) / d + 2) / 6; break
      case b: h = ((r - g) / d + 4) / 6; break
    }
  }

  return `hsl(${Math.round(h * 360)}, 22%, ${isDark ? 18 : 93}%)`
}

const getAccentBorder = (hex: string): string => {
  return hex || 'var(--accent)'
}

/* ─── Component ─────────────────────────────────── */

export default function TimetablePage() {
  const [weekData, setWeekData] = useState<WeekData | null>(null)
  const [loading, setLoading] = useState(true)
  const [currentWeekStart, setCurrentWeekStart] = useState(
    () => startOfWeek(new Date(), { weekStartsOn: 1 })
  )
  const [uploading, setUploading] = useState(false)
  const [nusmodsUrl, setNusmodsUrl] = useState('')
  const [viewMode, setViewMode] = useState<'horizontal' | 'vertical'>('horizontal')
  const [showTasks, setShowTasks] = useState(false)
  const [weekTasks, setWeekTasks] = useState<WeekTask[]>([])
  const fileRef = useRef<HTMLInputElement>(null)

  // Detect dark mode
  const [isDark, setIsDark] = useState(false)
  useEffect(() => {
    const check = () => setIsDark(document.documentElement.classList.contains('dark'))
    check()
    const obs = new MutationObserver(check)
    obs.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] })
    return () => obs.disconnect()
  }, [])

  const formatDateParam = (d: Date) => format(d, 'yyyy-MM-dd')

  const fetchWeek = async (monday: Date): Promise<WeekData | null> => {
    try {
      setLoading(true)
      const data = await api.get('/timetable/week', { date: formatDateParam(monday) })
      setWeekData(data)
      return data
    } catch (err) {
      console.error('Failed to fetch timetable:', err)
      return null
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchWeek(currentWeekStart)
  }, [currentWeekStart])

  // Fetch tasks for the week when showTasks is enabled
  useEffect(() => {
    if (!showTasks) { setWeekTasks([]); return }
    const monday = currentWeekStart
    const sunday = new Date(monday)
    sunday.setDate(sunday.getDate() + 6)
    api.get('/tasks', {
      due_after: formatDateParam(monday),
      due_before: formatDateParam(sunday),
    }).then(data => setWeekTasks((data.tasks || []).filter((t: WeekTask) => t.due_date && t.status !== 'completed')))
      .catch(() => setWeekTasks([]))
  }, [showTasks, currentWeekStart])

  // Load and save settings
  useEffect(() => {
    api.get('/settings/show_tasks_on_timetable')
      .then(res => setShowTasks(res.value === 'true'))
      .catch(() => { })
  }, [])

  const toggleShowTasks = () => {
    const next = !showTasks
    setShowTasks(next)
    api.put('/settings/show_tasks_on_timetable', { value: next ? 'true' : 'false' }).catch(() => { })
  }

  // Helper: get tasks for a specific day
  const getTasksForDay = (dayIdx: number): WeekTask[] => {
    if (!showTasks || weekTasks.length === 0) return []
    const d = new Date(currentWeekStart)
    d.setDate(d.getDate() + dayIdx)
    const dateStr = formatDateParam(d)
    return weekTasks.filter(t => t.due_date === dateStr)
  }

  /* ─── Week navigation ─── */
  const goToPrev = () => setCurrentWeekStart(addWeeks(currentWeekStart, -1))
  const goToNext = () => setCurrentWeekStart(addWeeks(currentWeekStart, 1))
  const goToToday = () => setCurrentWeekStart(startOfWeek(new Date(), { weekStartsOn: 1 }))

  const handleToggleAttendance = async (slotId: number, currentStatus: boolean, e: React.MouseEvent) => {
    e.stopPropagation()
    const nextStatus = !currentStatus

    // Optimistic update
    setWeekData(prev => {
      if (!prev) return prev
      return {
        ...prev,
        slots: prev.slots.map(s => s.id === slotId ? { ...s, is_attended: nextStatus } : s)
      }
    })

    try {
      await api.patch(`/timetable/slots/${slotId}?is_attended=${nextStatus}`)
    } catch (err) {
      console.error('Failed to toggle attendance:', err)
      // Revert on error
      setWeekData(prev => {
        if (!prev) return prev
        return {
          ...prev,
          slots: prev.slots.map(s => s.id === slotId ? { ...s, is_attended: currentStatus } : s)
        }
      })
    }
  }

  /* ─── ICS import ─── */
  /** After import, jump to the nearest teaching week if currently in a non-teaching period. */
  const navigateToTeachingWeek = (data: WeekData | null) => {
    if (!data) return
    const label = data.academic_week?.label || ''
    const isNonTeaching = ['Recess Week', 'Reading Week', 'Vacation', 'Before Semester', 'Outside Semester'].includes(label)
      || label.startsWith('Exam Week')
    if (isNonTeaching) {
      const semStart = data.academic_week?.semester_start
      if (semStart) {
        // Go to week 1 of the semester
        const semMonday = startOfWeek(new Date(semStart), { weekStartsOn: 1 })
        setCurrentWeekStart(semMonday)
        return
      }
      // Fallback: jump forward 1 week
      setCurrentWeekStart(addWeeks(currentWeekStart, 1))
    }
  }

  const timeSlots = useMemo(() => {
    const slots = weekData?.slots || []
    if (slots.length === 0) {
      // Return a reasonable default block (08:00 - 18:00)
      return Array.from({ length: 11 }, (_, i) => `${(i + 8).toString().padStart(2, '0')}:00`)
    }

    let minH = 24
    let maxH = 0

    slots.forEach(s => {
      const sH = parseInt(s.start_time.split(':')[0])
      const [eHStr, eMStr] = s.end_time.split(':')
      let eH = parseInt(eHStr)
      if (parseInt(eMStr || '0') > 0) eH += 1

      if (sH < minH) minH = sH
      if (eH > maxH) maxH = eH
    })

    // Safety fallback
    if (minH >= maxH) {
      return Array.from({ length: 11 }, (_, i) => `${(i + 8).toString().padStart(2, '0')}:00`)
    }

    return Array.from({ length: maxH - minH }, (_, i) => `${(i + minH).toString().padStart(2, '0')}:00`)
  }, [weekData])

  const handleUrlImport = async () => {
    if (!nusmodsUrl) return
    setUploading(true)
    try {
      await api.post(`/timetable/import-url?url=${encodeURIComponent(nusmodsUrl)}`)
      setNusmodsUrl('')
      const data = await fetchWeek(currentWeekStart)
      navigateToTeachingWeek(data)
    } catch (err: any) {
      console.error('URL import failed:', err)
      alert(`Import failed: ${err.message || 'Make sure the URL is a valid NUSMods share link.'}`)
    } finally {
      setUploading(false)
    }
  }

  const handleImport = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return
    setUploading(true)
    try {
      const formData = new FormData()
      formData.append('file', file)
      await api.upload('/timetable/import', formData)
      const data = await fetchWeek(currentWeekStart)
      navigateToTeachingWeek(data)
    } catch (err: any) {
      console.error('Import failed:', err)
      alert(`Import failed: ${err.message || 'Make sure the file is a valid NUSMods .ics export.'}`)
    } finally {
      setUploading(false)
      if (fileRef.current) fileRef.current.value = ''
    }
  }

  /* ─── Grid cell helpers ─── */
  const getCellData = (dayIdx: number, timeSlot: string) => {
    if (!weekData) return { slotStart: null, isSpanned: false }
    const currentHour = parseInt(timeSlot.split(':')[0])

    const slotStart = weekData.slots.find((s) => {
      if (s.day_of_week !== dayIdx) return false
      const sH = parseInt(s.start_time.split(':')[0])
      return sH === currentHour
    })

    const isSpanned = !slotStart && weekData.slots.some((s) => {
      if (s.day_of_week !== dayIdx) return false
      const sH = parseInt(s.start_time.split(':')[0])
      const [eHStr, eMStr] = s.end_time.split(':')
      let eH = parseInt(eHStr)
      if (parseInt(eMStr || '0') > 0) eH += 1
      return currentHour > sH && currentHour < eH
    })

    return { slotStart: slotStart || null, isSpanned }
  }

  const getColOrRowSpan = (slot: TimetableSlot) => {
    const sH = parseInt(slot.start_time.split(':')[0])
    const [eHStr, eMStr] = slot.end_time.split(':')
    let eH = parseInt(eHStr)
    if (parseInt(eMStr || '0') > 0) eH += 1
    return Math.max(1, eH - sH)
  }

  /* ─── Weekly Insights ─── */
  const weeklyInsights = useMemo(() => {
    if (!weekData || weekData.slots.length === 0) return null

    // 1. Total Contact Hours
    let totalMinutes = 0
    // 2. Busiest Day
    const dayMinutes = new Array(8).fill(0) // 1-7 for Mon-Sun
    // 3. Skipped Classes
    let skippedCount = 0
    // 4. Unique Modules
    const uniqueMods = new Set<string>()

    for (const slot of weekData.slots) {
      // Calculate duration
      const sH = parseInt(slot.start_time.split(':')[0])
      const sM = parseInt(slot.start_time.split(':')[1])
      const eH = parseInt(slot.end_time.split(':')[0])
      const eM = parseInt(slot.end_time.split(':')[1])
      
      const startTotal = sH * 60 + sM
      const endTotal = eH * 60 + eM
      const duration = endTotal - startTotal

      totalMinutes += duration
      dayMinutes[slot.day_of_week] += duration

      if (slot.is_attended === false) {
        skippedCount++
      }

      uniqueMods.add(slot.module_code)
    }

    const totalHours = Math.round((totalMinutes / 60) * 10) / 10

    let busiestDayIdx = 1
    let maxMins = 0
    for (let i = 1; i <= 7; i++) {
        if (dayMinutes[i] > maxMins) {
            maxMins = dayMinutes[i]
            busiestDayIdx = i
        }
    }
    const busiestDay = FULL_DAYS[busiestDayIdx - 1] || 'None'
    const busiestHours = Math.round((maxMins / 60) * 10) / 10

    return {
      totalHours,
      busiestDay,
      busiestHours,
      skippedCount,
      moduleCount: uniqueMods.size
    }
  }, [weekData])

  const todayDow = new Date().getDay() // 0=Sunday
  const weekEnd = new Date(currentWeekStart)
  weekEnd.setDate(weekEnd.getDate() + 6)

  const academicLabel = weekData?.academic_week?.label || ''
  const semLabel = weekData?.academic_week?.academic_year
    ? `Sem ${weekData.academic_week.semester} · AY${weekData.academic_week.academic_year}`
    : ''

  return (
    <div className="p-4 md:p-6 w-full mx-auto">
      {/* ─── Header ─── */}
      <header className="border-b-2 border-primary/20 pb-3 mb-4">
        <div className="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
          {/* Title cluster */}
          <div className="flex items-center gap-2 md:gap-3 flex-wrap">
            <span
              className="h-[2px] w-8 hidden md:block"
              style={{ background: 'var(--urgency, #C4836A)' }}
            />
            <h1 className="font-serif text-2xl md:text-3xl text-primary leading-none">
              {academicLabel || 'Timetable'}
            </h1>
            {semLabel && (
              <>
                <span className="text-muted font-mono text-xs hidden sm:inline">•</span>
                <span className="font-mono text-xs text-secondary">{semLabel}</span>
              </>
            )}
            <span className="text-muted font-mono text-xs hidden sm:inline">•</span>
            <span className="font-serif text-sm text-secondary italic">
              {format(currentWeekStart, 'MMM d')} — {format(weekEnd, 'MMM d')}
            </span>
          </div>

          {/* Controls */}
          <div className="flex items-center gap-2 flex-wrap">
            {/* Show Tasks Toggle */}
            <div className="flex items-center border border-border bg-surface mr-2 rounded-sm overflow-hidden h-9">
              <button
                onClick={toggleShowTasks}
                title={showTasks ? 'Hide Tasks' : 'Show Tasks'}
                className={`h-full flex items-center gap-1.5 px-3 transition-colors ${showTasks ? 'bg-primary/10 text-primary' : 'text-muted hover:bg-surface-hover'}`}
              >
                <CheckSquare className="w-4 h-4" />
                <span className="text-xs font-mono font-medium hidden sm:inline">Tasks</span>
              </button>
            </div>

            {/* View Toggle */}
            <div className="flex items-center border border-border bg-surface mr-2 rounded-sm overflow-hidden h-9">
              <button
                onClick={() => setViewMode('horizontal')}
                title="Horizontal View (Days on Y, Time on X)"
                className={`w-10 h-full flex items-center justify-center transition-colors ${viewMode === 'horizontal' ? 'bg-primary/10 text-primary' : 'text-muted hover:bg-surface-hover'
                  }`}
              >
                <LayoutGrid className="w-4 h-4" />
              </button>
              <div className="w-px h-6 bg-border" />
              <button
                onClick={() => setViewMode('vertical')}
                title="Vertical View (Time on Y, Days on X)"
                className={`w-10 h-full flex items-center justify-center transition-colors ${viewMode === 'vertical' ? 'bg-primary/10 text-primary' : 'text-muted hover:bg-surface-hover'
                  }`}
              >
                <Columns className="w-4 h-4" />
              </button>
            </div>

            <button
              onClick={goToPrev}
              className="h-9 w-9 flex items-center justify-center border border-border bg-surface hover:bg-surface-hover transition-colors rounded-sm"
            >
              <ChevronLeft className="h-4 w-4 text-secondary" />
            </button>
            <button
              onClick={goToToday}
              className="px-4 h-9 border border-border bg-surface text-xs font-mono font-medium uppercase tracking-widest text-primary hover:bg-surface-hover transition-colors rounded-sm"
            >
              Today
            </button>
            <button
              onClick={goToNext}
              className="h-9 w-9 flex items-center justify-center border border-border bg-surface hover:bg-surface-hover transition-colors rounded-sm"
            >
              <ChevronRight className="h-4 w-4 text-secondary" />
            </button>

            <div className="w-px h-6 bg-border mx-1 hidden sm:block" />

            <label className="cursor-pointer hidden sm:block">
              <input
                type="file"
                accept=".ics"
                className="hidden"
                onChange={handleImport}
                ref={fileRef}
              />
              <span className="flex items-center gap-1.5 px-3 h-9 text-xs font-mono font-medium border border-border bg-surface text-secondary hover:bg-surface-hover transition-colors rounded-sm">
                <Upload className="h-3.5 w-3.5" />
                {uploading ? '…' : 'ICS'}
              </span>
            </label>

            <div className="flex items-center border border-border bg-surface ml-2 rounded-sm overflow-hidden h-9 hidden xl:flex">
              <input
                type="text"
                placeholder="Paste NUSMods URL..."
                value={nusmodsUrl}
                onChange={(e) => setNusmodsUrl(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleUrlImport()}
                className="bg-transparent border-none text-xs font-mono h-full px-3 w-48 focus:ring-0 placeholder:text-muted"
              />
              <button
                onClick={handleUrlImport}
                disabled={!nusmodsUrl || uploading}
                title="Import from NUSMods URL"
                className="h-full px-3 text-secondary hover:bg-surface-hover transition-colors border-l border-border disabled:opacity-50"
              >
                {uploading ? (
                  <span className="animate-spin text-[10px]">◌</span>
                ) : (
                  <LinkIcon className="w-3.5 h-3.5" />
                )}
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* ─── Grid ─── */}
      {loading ? (
        <div className="flex items-center justify-center h-96">
          <span className="text-muted text-xs font-mono uppercase tracking-widest">
            Loading timetable…
          </span>
        </div>
      ) : !weekData || (weekData.slots.length === 0 && (weekData.total_slots ?? 0) === 0) ? (
        <div className="border border-border bg-surface p-12 text-center rounded-sm">
          <p className="font-serif text-lg text-primary mb-2">No class schedules yet</p>
          <p className="font-mono text-xs text-muted mb-6">
            Import your NUSMods .ics file to get started
          </p>
          <button
            onClick={() => fileRef.current?.click()}
            className="px-5 py-2.5 border border-border bg-surface text-xs font-mono font-medium uppercase tracking-widest text-primary hover:bg-surface-hover transition-colors rounded-sm"
          >
            <Upload size={14} className="inline mr-2 -mt-0.5" />
            Import Timetable
          </button>
        </div>
      ) : weekData.slots.length === 0 ? (
        /* Slots are imported but none this week (recess/vacation/reading week) */
        <div className="border border-border bg-surface rounded-sm">
          <div className="flex flex-col items-center justify-center py-16 px-6 text-center">
            <Coffee className="h-10 w-10 text-muted mb-4" strokeWidth={1.5} />
            <p className="font-serif text-lg text-primary mb-1.5">
              {weekData.academic_week?.label || 'No Classes This Week'}
            </p>
            <p className="font-mono text-xs text-muted max-w-xs">
              {weekData.academic_week?.label === 'Recess Week'
                ? 'Enjoy your break! Classes resume next week.'
                : weekData.academic_week?.label === 'Reading Week'
                  ? 'Reading week — time to catch up and revise.'
                  : weekData.academic_week?.label?.startsWith('Exam Week')
                    ? 'Exam period — good luck!'
                    : 'No classes scheduled for this week.'}
            </p>
            <p className="font-mono text-[10px] text-muted mt-3">
              {weekData.total_slots} class{weekData.total_slots !== 1 ? 'es' : ''} imported · navigate to a teaching week to view
            </p>
          </div>
        </div>
      ) : (
        <div className="border border-border bg-surface overflow-hidden rounded-sm">
          <div className="overflow-x-auto">
            {viewMode === 'vertical' ? (
              /* ========================================= */
              /* VERTICAL VIEW (Time on Y, Days on X)      */
              /* ========================================= */
              <table className="w-full border-collapse" style={{ minWidth: 700 }}>
                {/* ─── Header row ─── */}
                <thead>
                  <tr>
                    <th
                      className="p-3 text-center font-mono text-xs font-medium uppercase tracking-wider text-muted border-b border-border border-r border-border bg-base"
                      style={{ width: 64 }}
                    >
                      Time
                    </th>
                    {DAYS.map((day, i) => {
                      const isToday = todayDow === i + 1
                      return (
                        <th
                          key={day}
                          className={`p-3 text-center border-b border-border border-r border-border last:border-r-0 ${isToday ? 'bg-accent-subtle' : 'bg-base'
                            }`}
                          style={{ minWidth: 130 }}
                        >
                          <div className={`font-mono text-xs font-medium uppercase tracking-widest ${isToday ? 'text-accent' : 'text-muted'
                            }`}>
                            {day}
                          </div>
                          <div className={`font-serif text-sm italic mt-0.5 ${isToday ? 'text-accent' : 'text-secondary'
                            }`}>
                            {(() => {
                              const d = new Date(currentWeekStart)
                              d.setDate(d.getDate() + i)
                              return format(d, 'MMM d')
                            })()}
                          </div>
                        </th>
                      )
                    })}
                  </tr>
                </thead>

                {/* ─── Time rows ─── */}
                <tbody>
                  {timeSlots.map((time, timeIdx) => {
                    return (
                      <tr key={time}>
                        {/* Time label */}
                        <td
                          className="p-2 text-center font-mono text-[10px] text-muted align-top border-r border-border-subtle bg-base"
                          style={{ height: 64 }}
                        >
                          {time}
                        </td>

                        {/* Day columns */}
                        {DAYS.map((_, dayIdx) => {
                          const { slotStart, isSpanned } = getCellData(dayIdx, time)
                          const isToday = todayDow === dayIdx + 1

                          // Cell is part of a spanning slot — skip (rowSpan handles it)
                          if (isSpanned) return null

                          // Empty cell
                          if (!slotStart) {
                            return (
                              <td
                                key={`${dayIdx}-${time}`}
                                className={`border-r border-border-subtle last:border-r-0 border-b border-border-subtle ${isToday ? 'bg-accent-subtle/30' : ''
                                  }`}
                                style={{
                                  height: 64,
                                  backgroundColor: !isToday
                                    ? timeIdx % 2 === 0
                                      ? 'rgba(0,0,0,0.01)'
                                      : 'transparent'
                                    : undefined,
                                }}
                              />
                            )
                          }

                          // Slot starts here — render with rowSpan
                          const rowSpan = getColOrRowSpan(slotStart)
                          const moduleColor = slotStart.course_colour || '#7C8C6E'
                          const bgColor = getLowSatBg(moduleColor, isDark)
                          const typeShort = getClassTypeShort(slotStart.lesson_type)

                          return (
                            <td
                              key={`${dayIdx}-${time}`}
                              className="align-top p-0 border-r border-border-subtle last:border-r-0 border-b border-border-subtle"
                              style={{ height: rowSpan * 64 }}
                              rowSpan={rowSpan}
                            >
                              <div
                                className={`group h-full mx-0.5 my-0.5 rounded-sm p-2.5 overflow-hidden flex flex-col gap-1 transition-all hover:brightness-110 shadow-sm ${slotStart.is_attended === false ? 'opacity-40 grayscale-[0.8]' : ''}`}
                                style={{
                                  backgroundColor: bgColor,
                                  borderLeft: `3px solid ${getAccentBorder(moduleColor)}`,
                                }}
                              >
                                <div className="flex items-center justify-between gap-1.5 flex-wrap w-full">
                                  <div className="flex items-center gap-1.5 flex-wrap">
                                    <span className="font-mono text-xs font-bold" style={{ color: moduleColor }}>
                                      {slotStart.module_code}
                                    </span>
                                    <span
                                      className="font-mono text-[9px] font-medium px-1.5 py-0.5 rounded-sm whitespace-nowrap"
                                      style={{
                                        backgroundColor: `${moduleColor}20`,
                                        color: moduleColor,
                                      }}
                                    >
                                      {typeShort}
                                      {slotStart.lesson_id ? ` [${slotStart.lesson_id}]` : ''}
                                    </span>
                                  </div>
                                  <button
                                    onClick={(e) => handleToggleAttendance(slotStart.id, slotStart.is_attended ?? true, e)}
                                    className={`h-5 w-5 rounded-md flex items-center justify-center shrink-0 transition-colors ${slotStart.is_attended !== false
                                      ? 'text-muted hover:text-primary hover:bg-black/5 opacity-0 group-hover:opacity-100'
                                      : 'text-muted bg-black/10 hover:bg-black/20 opacity-100'
                                      }`}
                                    title={slotStart.is_attended !== false ? "Mark as unattended" : "Mark as attended"}
                                  >
                                    {slotStart.is_attended !== false ? <Eye className="h-3 w-3" /> : <EyeOff className="h-3 w-3" />}
                                  </button>
                                </div>

                                {/* Module name */}
                                {slotStart.module_name && (
                                  <div className="text-[11px] text-secondary leading-tight line-clamp-2">
                                    {slotStart.module_name}
                                  </div>
                                )}

                                <div className="mt-auto pt-1 flex flex-col gap-0.5">
                                  {/* Time */}
                                  <div className="flex items-center gap-1 text-[10px] text-muted">
                                    <Clock size={10} strokeWidth={2} className="flex-shrink-0" />
                                    <span className="truncate">
                                      {slotStart.start_time} – {slotStart.end_time}
                                    </span>
                                  </div>

                                  {/* Venue */}
                                  {slotStart.venue && (
                                    <div className="flex items-center gap-1 text-[10px] text-muted">
                                      <MapPin size={10} strokeWidth={2} className="flex-shrink-0" />
                                      <span className="truncate">{slotStart.venue}</span>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </td>
                          )
                        })}
                      </tr>
                    )
                  })}
                </tbody>

                {/* ─── Task row (bottom of vertical grid) ─── */}
                {showTasks && weekTasks.length > 0 && (
                  <tfoot>
                    <tr>
                      <td className="p-2 text-center font-mono text-[10px] text-muted align-top border-r border-border-subtle bg-base border-t border-border" style={{ height: 'auto' }}>
                        Tasks
                      </td>
                      {DAYS.map((_, dayIdx) => {
                        const dayTasks = getTasksForDay(dayIdx)
                        return (
                          <td key={`tasks-${dayIdx}`} className="p-1.5 align-top border-r border-border-subtle last:border-r-0 border-t border-border" style={{ minHeight: 40 }}>
                            {dayTasks.length > 0 ? (
                              <div className="space-y-1">
                                {dayTasks.map(t => (
                                  <div
                                    key={t.id}
                                    className="rounded-sm px-2 py-1.5 text-[10px] leading-tight truncate"
                                    style={{
                                      backgroundColor: t.priority === 'urgent' || t.priority === 'high'
                                        ? 'var(--urgency-subtle)'
                                        : 'var(--accent-subtle)',
                                      borderLeft: `2px solid ${t.priority === 'urgent' || t.priority === 'high' ? 'var(--urgency)' : 'var(--accent)'}`,
                                      color: t.priority === 'urgent' || t.priority === 'high'
                                        ? 'var(--urgency)'
                                        : 'var(--accent)',
                                    }}
                                  >
                                    <span className="font-medium">{t.title}</span>
                                    {t.due_time && (
                                      <span className="ml-1 opacity-70 font-mono">{t.due_time.slice(0, 5)}</span>
                                    )}
                                  </div>
                                ))}
                              </div>
                            ) : null}
                          </td>
                        )
                      })}
                    </tr>
                  </tfoot>
                )}
              </table>
            ) : (
              /* ========================================= */
              /* HORIZONTAL VIEW (Days on Y, Time on X)    */
              /* ========================================= */
              <table className="w-full border-collapse table-fixed" style={{ minWidth: 1000 }}>
                {/* ─── Header row (Times) ─── */}
                <thead>
                  <tr>
                    <th
                      className="p-3 text-center font-mono text-xs font-medium uppercase tracking-wider text-muted border-b border-border border-r border-border bg-base w-24 sticky left-0 z-10"
                    >
                      Day
                    </th>
                    {timeSlots.map((time) => (
                      <th
                        key={time}
                        className="p-2 text-left font-mono text-[10px] text-muted border-b border-border border-r border-border-subtle bg-base w-32"
                      >
                        {time}
                      </th>
                    ))}
                  </tr>
                </thead>

                {/* ─── Day rows ─── */}
                <tbody>
                  {DAYS.map((day, dayIdx) => {
                    const isToday = todayDow === dayIdx + 1

                    return (
                      <tr key={day} className={isToday ? 'bg-accent-subtle/10' : ''}>
                        {/* Day label */}
                        <td
                          className={`p-3 border-r border-border border-b border-border-subtle sticky left-0 z-10 ${isToday ? 'bg-accent-subtle/30' : 'bg-base'
                            }`}
                        >
                          <div className={`font-mono text-xs font-medium uppercase tracking-widest ${isToday ? 'text-accent' : 'text-muted'
                            }`}>
                            {day}
                          </div>
                          <div className={`font-serif text-sm italic mt-0.5 ${isToday ? 'text-accent' : 'text-secondary'
                            }`}>
                            {(() => {
                              const d = new Date(currentWeekStart)
                              d.setDate(d.getDate() + dayIdx)
                              return format(d, 'MMM d')
                            })()}
                          </div>

                          {/* Task pills under day label */}
                          {showTasks && (() => {
                            const dayTasks = getTasksForDay(dayIdx)
                            if (dayTasks.length === 0) return null
                            return (
                              <div className="mt-1.5 space-y-0.5">
                                {dayTasks.slice(0, 3).map(t => (
                                  <div
                                    key={t.id}
                                    className="rounded-sm px-1.5 py-0.5 text-[9px] leading-tight truncate max-w-full"
                                    style={{
                                      backgroundColor: t.priority === 'urgent' || t.priority === 'high'
                                        ? 'var(--urgency-subtle)'
                                        : 'var(--accent-subtle)',
                                      borderLeft: `2px solid ${t.priority === 'urgent' || t.priority === 'high' ? 'var(--urgency)' : 'var(--accent)'}`,
                                      color: t.priority === 'urgent' || t.priority === 'high'
                                        ? 'var(--urgency)'
                                        : 'var(--accent)',
                                    }}
                                  >
                                    {t.title}
                                  </div>
                                ))}
                                {dayTasks.length > 3 && (
                                  <div className="text-[8px] text-muted font-mono">+{dayTasks.length - 3} more</div>
                                )}
                              </div>
                            )
                          })()}
                        </td>

                        {/* Time columns */}
                        {timeSlots.map((time, timeIdx) => {
                          const { slotStart, isSpanned } = getCellData(dayIdx, time)

                          // Cell is part of a spanning slot — skip (colSpan handles it)
                          if (isSpanned) return null

                          // Empty cell
                          if (!slotStart) {
                            return (
                              <td
                                key={`${day}-${time}`}
                                className={`border-r border-border-subtle border-b border-border-subtle h-[110px] ${isToday ? 'border-r-accent-subtle/50' : ''}`}
                                style={{
                                  backgroundColor: !isToday
                                    ? timeIdx % 2 === 0
                                      ? 'rgba(0,0,0,0.01)'
                                      : 'transparent'
                                    : undefined,
                                }}
                              />
                            )
                          }

                          // Slot starts here — render with colSpan
                          const colSpan = getColOrRowSpan(slotStart)
                          const moduleColor = slotStart.course_colour || '#7C8C6E'
                          const bgColor = getLowSatBg(moduleColor, isDark)
                          const typeShort = getClassTypeShort(slotStart.lesson_type)

                          return (
                            <td
                              key={`${day}-${time}`}
                              className="p-1 border-r border-border-subtle border-b border-border-subtle align-top h-[110px]"
                              colSpan={colSpan}
                            >
                              <div
                                className={`group h-full rounded-sm p-2.5 overflow-hidden flex flex-col gap-1 transition-all hover:brightness-110 shadow-sm ${slotStart.is_attended === false ? 'opacity-40 grayscale-[0.8]' : ''}`}
                                style={{
                                  backgroundColor: bgColor,
                                  borderLeft: `3px solid ${getAccentBorder(moduleColor)}`,
                                }}
                              >
                                <div className="flex items-center justify-between gap-1 flex-wrap">
                                  <div className="flex items-center gap-1.5 flex-wrap">
                                    <span className="font-mono text-xs font-bold" style={{ color: moduleColor }}>
                                      {slotStart.module_code}
                                    </span>
                                    <span
                                      className="font-mono text-[9px] font-medium px-1.5 py-0.5 rounded-sm whitespace-nowrap"
                                      style={{
                                        backgroundColor: `${moduleColor}20`,
                                        color: moduleColor,
                                      }}
                                    >
                                      {typeShort}
                                      {slotStart.lesson_id ? ` [${slotStart.lesson_id}]` : ''}
                                    </span>
                                  </div>
                                  <button
                                    onClick={(e) => handleToggleAttendance(slotStart.id, slotStart.is_attended ?? true, e)}
                                    className={`h-5 w-5 rounded-md flex items-center justify-center shrink-0 transition-colors ${slotStart.is_attended !== false
                                      ? 'text-muted hover:text-primary hover:bg-black/5 opacity-0 group-hover:opacity-100'
                                      : 'text-muted bg-black/10 hover:bg-black/20 opacity-100'
                                      }`}
                                    title={slotStart.is_attended !== false ? "Mark as unattended" : "Mark as attended"}
                                  >
                                    {slotStart.is_attended !== false ? <Eye className="h-3 w-3" /> : <EyeOff className="h-3 w-3" />}
                                  </button>
                                </div>

                                {slotStart.module_name && colSpan > 1 && (
                                  <div className="text-[11px] text-secondary leading-tight line-clamp-1 truncate">
                                    {slotStart.module_name}
                                  </div>
                                )}

                                <div className="mt-auto pt-1 flex items-center justify-between gap-2 overflow-hidden flex-wrap shrink-0">
                                  <div className="flex items-center gap-1 text-[10px] text-muted">
                                    <Clock size={10} strokeWidth={2} className="flex-shrink-0" />
                                    <span className="truncate">
                                      {slotStart.start_time} – {slotStart.end_time}
                                    </span>
                                  </div>

                                  {slotStart.venue && colSpan > 1 && (
                                    <div className="flex items-center gap-1 text-[10px] text-muted">
                                      <MapPin size={10} strokeWidth={2} className="flex-shrink-0" />
                                      <span className="truncate">{slotStart.venue}</span>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </td>
                          )
                        })}
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            )}
          </div>
        </div>
      )}

      {/* ─── Weekly Insights ─── */}
      {weeklyInsights && (
        <div className="mt-4 border border-border bg-surface p-4 rounded-sm">
          <div className="font-mono text-[10px] text-muted uppercase tracking-widest mb-3 flex items-center gap-1.5">
            <Activity className="h-3 w-3" />
            Weekly Insights
          </div>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            
            {/* Total Contact Hours */}
            <div className="flex flex-col p-3 rounded-sm border border-border-subtle bg-base/50">
              <div className="flex items-center gap-1.5 text-muted mb-1 font-mono text-[10px] uppercase tracking-wider">
                <Clock className="h-3 w-3" />
                Contact Hours
              </div>
              <div className="flex items-baseline gap-1">
                <span className="font-serif text-2xl text-primary leading-none">{weeklyInsights.totalHours}</span>
                <span className="font-mono text-[10px] text-muted">hrs</span>
              </div>
            </div>

            {/* Busiest Day */}
            <div className="flex flex-col p-3 rounded-sm border border-border-subtle bg-base/50">
              <div className="flex items-center gap-1.5 text-muted mb-1 font-mono text-[10px] uppercase tracking-wider">
                <CalendarDays className="h-3 w-3" />
                Busiest Day
              </div>
              <div className="flex flex-col justify-center h-[24px]">
                <span className="font-serif text-lg text-primary leading-none">{weeklyInsights.busiestDay}</span>
                {weeklyInsights.busiestHours > 0 && (
                   <span className="font-mono text-[9px] text-secondary mt-0.5">{weeklyInsights.busiestHours} hrs of classes</span>
                )}
              </div>
            </div>

            {/* Skipped Classes */}
            <div className={`flex flex-col p-3 rounded-sm border border-border-subtle ${weeklyInsights.skippedCount > 0 ? 'bg-[var(--urgency-subtle)]/30 border-[var(--urgency)]/20' : 'bg-base/50'}`}>
              <div className={`flex items-center gap-1.5 mb-1 font-mono text-[10px] uppercase tracking-wider ${weeklyInsights.skippedCount > 0 ? 'text-[var(--urgency)]' : 'text-muted'}`}>
                <AlertCircle className="h-3 w-3" />
                Skipped Classes
              </div>
              <div className="flex items-baseline gap-1">
                <span className={`font-serif text-2xl leading-none ${weeklyInsights.skippedCount > 0 ? 'text-[var(--urgency)]' : 'text-primary'}`}>{weeklyInsights.skippedCount}</span>
                <span className="font-mono text-[10px] text-muted">classes</span>
              </div>
            </div>

            {/* Module Count */}
            <div className="flex flex-col p-3 rounded-sm border border-border-subtle bg-base/50">
              <div className="flex items-center gap-1.5 text-muted mb-1 font-mono text-[10px] uppercase tracking-wider">
                <BookOpen className="h-3 w-3" />
                Active Modules
              </div>
              <div className="flex items-baseline gap-1">
                <span className="font-serif text-2xl text-primary leading-none">{weeklyInsights.moduleCount}</span>
                <span className="font-mono text-[10px] text-muted">mods</span>
              </div>
            </div>

          </div>
        </div>
      )}
    </div>
  )
}
```
```

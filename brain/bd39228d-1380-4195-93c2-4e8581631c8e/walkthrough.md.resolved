# NUSmods Timetable Import - Walkthrough

## Summary

Added the NUSmods timetable import functionality directly to the planner page, allowing users to import their class schedules without navigating away from the planner.

## Changes Made

### [page.tsx](file:///Users/oli/Desktop/LMSManager/frontend/app/planner/page.tsx)

Added the following features to the planner page:

1. **Import Timetable Button** - A blue-themed button in the controls section that opens the import panel
2. **Import Panel** - Collapsible panel with two import methods:
   - **ICS File** - Upload an ICS file exported from NUSmods
   - **NUSmods URL** - Paste a NUSmods share URL to parse and select classes
3. **Class Selection Modal** - Integrated the existing [ClassSelectionModal](file:///Users/oli/Desktop/LMSManager/frontend/components/timetable/class-selection-modal.tsx#26-222) component for selecting which classes to import from NUSmods URLs

```diff:page.tsx
"use client";

import { useState, useMemo, useEffect } from "react";
import { useRouter } from "next/navigation";
import { ChevronLeft, ChevronRight, Sun, Moon, Eye, EyeOff, Download, Plus, Edit2, Check, Trash2, Users } from "lucide-react";
import { WeeklyTimetable } from "@/components/planner/weekly-timetable";
import { QuickAddModal } from "@/components/planner/quick-add-modal";
import { useTimeBlocks, useTimetable, useAcademicCalendar } from "@/lib/hooks";
import { timeblocksAPI, timetableAPI } from "@/lib/api";
import { useTheme } from "@/lib/providers/theme-provider";
import { startOfWeek, addWeeks, format } from "date-fns";

const SHOW_TIMETABLE_KEY = "planner_show_timetable";

export default function PlannerPage() {
  const router = useRouter();
  const { theme, setTheme, actualTheme } = useTheme();
  const [currentWeekStart, setCurrentWeekStart] = useState(() => startOfWeek(new Date(), { weekStartsOn: 1 }));
  const [showQuickAdd, setShowQuickAdd] = useState(false);
  const [selectedCell, setSelectedCell] = useState<{ day: Date; hour: number } | null>(null);
  const [editingBlock, setEditingBlock] = useState<any>(null);
  const [showTimetable, setShowTimetable] = useState(true);
  const [isEditMode, setIsEditMode] = useState(false);

  // Fetch academic calendar
  const { academicCalendar } = useAcademicCalendar();

  const toggleTheme = () => {
    setTheme(actualTheme === "dark" ? "light" : "dark");
  };

  // Calculate week end
  const weekEnd = useMemo(() => {
    const end = new Date(currentWeekStart);
    end.setDate(end.getDate() + 7);
    return end;
  }, [currentWeekStart]);

  // Fetch time blocks for the week
  const { timeBlocks, isLoading, mutate } = useTimeBlocks(currentWeekStart, weekEnd);

  // Fetch timetable data
  const { timetable: classSchedules, isLoading: isLoadingTimetable, mutate: mutateTimetable } = useTimetable();

  // Get unique modules for legend
  const uniqueModules = useMemo(() => {
    const moduleMap = new Map<string, { code: string; name: string; color: string }>();
    classSchedules?.forEach(schedule => {
      if (!moduleMap.has(schedule.module_code)) {
        moduleMap.set(schedule.module_code, {
          code: schedule.module_code,
          name: schedule.module_name,
          color: schedule.color,
        });
      }
    });
    return Array.from(moduleMap.values());
  }, [classSchedules]);

  // Load show timetable preference from localStorage
  useEffect(() => {
    const stored = localStorage.getItem(SHOW_TIMETABLE_KEY);
    if (stored !== null) {
      setShowTimetable(stored === "true");
    }
  }, []);

  // Save show timetable preference to localStorage
  const handleToggleShowTimetable = () => {
    const newValue = !showTimetable;
    setShowTimetable(newValue);
    localStorage.setItem(SHOW_TIMETABLE_KEY, String(newValue));
  };

  // Handle week navigation
  const goToPreviousWeek = () => {
    setCurrentWeekStart(addWeeks(currentWeekStart, -1));
  };

  const goToNextWeek = () => {
    setCurrentWeekStart(addWeeks(currentWeekStart, 1));
  };

  const goToToday = () => {
    setCurrentWeekStart(startOfWeek(new Date(), { weekStartsOn: 1 }));
  };

  // Handle add block from cell click
  const handleAddBlock = (day: Date, hour: number) => {
    setSelectedCell({ day, hour });
    setShowQuickAdd(true);
  };

  // Handle edit block
  const handleEditBlock = (block: any) => {
    setEditingBlock(block);
    setShowQuickAdd(true);
  };

  // Handle delete time block
  const handleDeleteBlock = async (blockId: number) => {
    if (!confirm("Are you sure you want to delete this time block?")) return;
    try {
      await timeblocksAPI.delete(blockId);
      mutate();
    } catch (error) {
      console.error("Failed to delete time block:", error);
      alert("Failed to delete time block. Please try again.");
    }
  };

  // Handle delete class schedule
  const handleDeleteSchedule = async (scheduleId: number) => {
    if (!confirm("Are you sure you want to delete this class?")) return;
    try {
      await timetableAPI.delete(scheduleId);
      mutateTimetable?.();
    } catch (error) {
      console.error("Failed to delete class schedule:", error);
      alert("Failed to delete class. Please try again.");
    }
  };

  // Handle create new block
  const handleCreateBlock = async (data: any) => {
    try {
      await timeblocksAPI.create(data);
      mutate();
      setShowQuickAdd(false);
      setSelectedCell(null);
    } catch (error) {
      console.error("Failed to create time block:", error);
      alert("Failed to create time block. Please try again.");
    }
  };

  // Handle update block
  const handleUpdateBlock = async (data: any) => {
    try {
      if (editingBlock) {
        await timeblocksAPI.update(editingBlock.id, data);
        mutate();
      }
      setShowQuickAdd(false);
      setEditingBlock(null);
    } catch (error) {
      console.error("Failed to update time block:", error);
      alert("Failed to update time block. Please try again.");
    }
  };

  // Get academic week number or fallback to calendar week
  const weekNumber = academicCalendar?.current_academic_week || Math.ceil((currentWeekStart.getDate() + 6) / 7);

  return (
    <div className={`min-h-screen font-sans antialiased transition-colors ${actualTheme === 'dark' ? 'bg-neutral-900 text-[#fdfcf8]' : 'bg-[#fdfcf8] text-[#1a1a1a]'}`}>
      <main className="w-full mx-auto px-4 md:px-6 py-4 md:py-6 max-w-[95%]">

        {/* Header Section - Compact Horizontal */}
        <div className="border-b-2 border-black dark:border-neutral-600 pb-2 mb-2">
          <div className="grid grid-cols-[1fr_auto_1fr] items-center">
            {/* Left spacer */}
            <div></div>

            {/* Center: Title and Date */}
            <div className="flex items-center gap-3 md:gap-4">
              <span className="bg-red-600 h-[2px] w-10 hidden md:block"></span>
              <span className="text-red-600 font-mono text-xs font-bold uppercase tracking-[0.2em]">
                {format(currentWeekStart, 'MMMM yyyy')}
              </span>
              <span className="text-black dark:text-white font-mono text-xs">•</span>
              <h2 className="text-2xl md:text-3xl font-serif font-black leading-none text-black dark:text-white">
                {academicCalendar ? `Academic Week ${weekNumber}` : `Week ${weekNumber}`}
              </h2>
              <span className="text-black dark:text-white font-mono text-xs">•</span>
              <p className="text-sm md:text-base font-serif text-black/60 dark:text-white/60">
                {format(currentWeekStart, 'MMM d')} — {format(weekEnd, 'MMM d')}
              </p>
            </div>

            {/* Right: Module Legend - Bigger */}
            {uniqueModules.length > 0 && (
              <div className="flex flex-wrap gap-2 justify-end">
                {uniqueModules.map((module) => (
                  <div
                    key={module.code}
                    className="flex items-center gap-2 px-3 py-1.5 border border-black dark:border-neutral-600 bg-white dark:bg-neutral-800"
                    title={module.name}
                  >
                    <div
                      className="w-3 h-3 rounded-full shrink-0"
                      style={{ backgroundColor: module.color }}
                    />
                    <span className="font-mono text-xs font-bold uppercase text-black dark:text-white">
                      {module.code}
                    </span>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Loading State */}
        {isLoading ? (
          <div className="flex items-center justify-center py-20">
            <span className="font-mono text-xs font-bold uppercase tracking-widest text-black/40 dark:text-white/40">
              Loading weekly schedule...
            </span>
          </div>
        ) : (
          <>
            {/* Calendar Grid */}
            <WeeklyTimetable
              timeBlocks={timeBlocks || []}
              weekStart={currentWeekStart}
              onAddBlock={handleAddBlock}
              onEditBlock={handleEditBlock}
              onDeleteBlock={handleDeleteBlock}
              onDeleteSchedule={handleDeleteSchedule}
              classSchedules={classSchedules || []}
              showTimetable={showTimetable}
              isEditMode={isEditMode}
            />

            {/* Controls Section - Single Centered Row */}
            <div className="mt-4 border-t border-black/20 dark:border-white/20 pt-4">
              <div className="flex items-center justify-center gap-3 flex-wrap">
                {/* Week Navigation */}
                <button
                  onClick={goToPreviousWeek}
                  className="px-4 h-10 border border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600 font-bold uppercase text-xs tracking-widest transition-colors flex items-center gap-2"
                >
                  <ChevronLeft size={16} />
                  <span className="hidden sm:inline">Previous Week</span>
                </button>
                <button
                  onClick={goToToday}
                  className="px-5 h-10 border border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600 font-bold uppercase text-xs tracking-widest transition-colors"
                >
                  Today
                </button>
                <button
                  onClick={goToNextWeek}
                  className="px-4 h-10 border border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600 font-bold uppercase text-xs tracking-widest transition-colors flex items-center gap-2"
                >
                  <span className="hidden sm:inline">Next Week</span>
                  <ChevronRight size={16} />
                </button>

                <div className="w-px h-6 bg-black/20 dark:bg-white/20"></div>

                {/* Timetable Controls */}
                <button
                  onClick={handleToggleShowTimetable}
                  className={`px-4 h-10 border font-bold uppercase text-xs tracking-widest flex items-center gap-2 transition-colors ${showTimetable ? 'border-black dark:border-neutral-500 bg-black dark:bg-neutral-600 text-white dark:text-white' : 'border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600'}`}
                  title={showTimetable ? "Hide timetable" : "Show timetable"}
                >
                  {showTimetable ? <Eye size={16} /> : <EyeOff size={16} />}
                  <span className="hidden sm:inline">Timetable</span>
                </button>

                {/* Edit Mode Toggle */}
                <button
                  onClick={() => setIsEditMode(!isEditMode)}
                  className={`px-4 h-10 border font-bold uppercase text-xs tracking-widest flex items-center gap-2 transition-colors ${isEditMode ? 'border-red-600 dark:border-red-500 bg-red-600 dark:bg-red-600 text-white' : 'border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600'}`}
                  title={isEditMode ? "Exit edit mode" : "Enter edit mode"}
                >
                  {isEditMode ? <Check size={16} /> : <Edit2 size={16} />}
                  <span className="hidden sm:inline">{isEditMode ? 'Done' : 'Edit'}</span>
                </button>

                {/* Meeting Finder */}
                <button
                  onClick={() => router.push('/planner/meeting-finder')}
                  className="px-4 h-10 border border-emerald-600 bg-emerald-50 dark:bg-emerald-950/20 text-emerald-700 dark:text-emerald-300 font-bold uppercase text-xs tracking-widest hover:bg-emerald-100 dark:hover:bg-emerald-950/40 transition-colors flex items-center gap-2"
                  title="Find meeting times with group"
                >
                  <Users size={16} />
                  <span className="hidden sm:inline">Meeting Finder</span>
                </button>

                <div className="w-px h-6 bg-black/20 dark:bg-white/20"></div>

                {/* Add Time Block */}
                <button
                  onClick={() => {
                    setSelectedCell({ day: new Date(), hour: new Date().getHours() });
                    setShowQuickAdd(true);
                  }}
                  className="px-5 h-10 bg-black text-white border border-black dark:bg-white dark:text-black dark:border-white font-bold uppercase text-xs tracking-widest hover:bg-neutral-800 dark:hover:bg-neutral-200 transition-colors flex items-center gap-2"
                >
                  <Plus size={16} />
                  <span>Add Time Block</span>
                </button>
              </div>
            </div>
          </>
        )}

        {/* Footer */}
        <footer className="max-w-[1400px] mx-auto px-4 md:px-6 py-6 border-t border-black/10 dark:border-white/10 text-center w-full mt-6">
          <div className="inline-block px-6 text-black/60 dark:text-white/60">
            <p className="font-mono text-[9px] uppercase tracking-[0.4em] opacity-60">Property of Academic Publishing Group © 2025</p>
          </div>
        </footer>
      </main>

      {/* Quick Add/Edit Modal */}
      {showQuickAdd && (
        <QuickAddModal
          isOpen={showQuickAdd}
          onClose={() => {
            setShowQuickAdd(false);
            setSelectedCell(null);
            setEditingBlock(null);
          }}
          onAdd={editingBlock ? handleUpdateBlock : handleCreateBlock}
          initialDay={selectedCell?.day}
          initialHour={selectedCell?.hour}
        />
      )}
    </div>
  );
}
===
"use client";

import { useState, useMemo, useEffect, useRef } from "react";
import { useRouter } from "next/navigation";
import { ChevronLeft, ChevronRight, Sun, Moon, Eye, EyeOff, Download, Plus, Edit2, Check, Trash2, Users, Upload, X, File, Link2, Loader2 } from "lucide-react";
import { WeeklyTimetable } from "@/components/planner/weekly-timetable";
import { QuickAddModal } from "@/components/planner/quick-add-modal";
import { ClassSelectionModal } from "@/components/timetable/class-selection-modal";
import { useTimeBlocks, useTimetable, useAcademicCalendar } from "@/lib/hooks";
import { timeblocksAPI, timetableAPI } from "@/lib/api";
import { useTheme } from "@/lib/providers/theme-provider";
import { startOfWeek, addWeeks, format } from "date-fns";

const SHOW_TIMETABLE_KEY = "planner_show_timetable";

export default function PlannerPage() {
  const router = useRouter();
  const { theme, setTheme, actualTheme } = useTheme();
  const [currentWeekStart, setCurrentWeekStart] = useState(() => startOfWeek(new Date(), { weekStartsOn: 1 }));
  const [showQuickAdd, setShowQuickAdd] = useState(false);
  const [selectedCell, setSelectedCell] = useState<{ day: Date; hour: number } | null>(null);
  const [editingBlock, setEditingBlock] = useState<any>(null);
  const [showTimetable, setShowTimetable] = useState(true);
  const [isEditMode, setIsEditMode] = useState(false);

  // Timetable import state
  const [showImport, setShowImport] = useState(false);
  const [importTab, setImportTab] = useState<"ics" | "nusmods">("ics");
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [isImporting, setIsImporting] = useState(false);
  const [statusMsg, setStatusMsg] = useState<{ type: "success" | "error"; text: string } | null>(null);
  const [nusmodsUrl, setNusmodsUrl] = useState("");
  const [showClassSelection, setShowClassSelection] = useState(false);
  const [parsedClasses, setParsedClasses] = useState<any[]>([]);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // Fetch academic calendar
  const { academicCalendar } = useAcademicCalendar();

  const toggleTheme = () => {
    setTheme(actualTheme === "dark" ? "light" : "dark");
  };

  // Calculate week end
  const weekEnd = useMemo(() => {
    const end = new Date(currentWeekStart);
    end.setDate(end.getDate() + 7);
    return end;
  }, [currentWeekStart]);

  // Fetch time blocks for the week
  const { timeBlocks, isLoading, mutate } = useTimeBlocks(currentWeekStart, weekEnd);

  // Fetch timetable data
  const { timetable: classSchedules, isLoading: isLoadingTimetable, mutate: mutateTimetable } = useTimetable();

  // Get unique modules for legend
  const uniqueModules = useMemo(() => {
    const moduleMap = new Map<string, { code: string; name: string; color: string }>();
    classSchedules?.forEach(schedule => {
      if (!moduleMap.has(schedule.module_code)) {
        moduleMap.set(schedule.module_code, {
          code: schedule.module_code,
          name: schedule.module_name,
          color: schedule.color,
        });
      }
    });
    return Array.from(moduleMap.values());
  }, [classSchedules]);

  // Load show timetable preference from localStorage
  useEffect(() => {
    const stored = localStorage.getItem(SHOW_TIMETABLE_KEY);
    if (stored !== null) {
      setShowTimetable(stored === "true");
    }
  }, []);

  // Save show timetable preference to localStorage
  const handleToggleShowTimetable = () => {
    const newValue = !showTimetable;
    setShowTimetable(newValue);
    localStorage.setItem(SHOW_TIMETABLE_KEY, String(newValue));
  };

  // Handle week navigation
  const goToPreviousWeek = () => {
    setCurrentWeekStart(addWeeks(currentWeekStart, -1));
  };

  const goToNextWeek = () => {
    setCurrentWeekStart(addWeeks(currentWeekStart, 1));
  };

  const goToToday = () => {
    setCurrentWeekStart(startOfWeek(new Date(), { weekStartsOn: 1 }));
  };

  // Handle add block from cell click
  const handleAddBlock = (day: Date, hour: number) => {
    setSelectedCell({ day, hour });
    setShowQuickAdd(true);
  };

  // Handle edit block
  const handleEditBlock = (block: any) => {
    setEditingBlock(block);
    setShowQuickAdd(true);
  };

  // Handle delete time block
  const handleDeleteBlock = async (blockId: number) => {
    if (!confirm("Are you sure you want to delete this time block?")) return;
    try {
      await timeblocksAPI.delete(blockId);
      mutate();
    } catch (error) {
      console.error("Failed to delete time block:", error);
      alert("Failed to delete time block. Please try again.");
    }
  };

  // Handle delete class schedule
  const handleDeleteSchedule = async (scheduleId: number) => {
    if (!confirm("Are you sure you want to delete this class?")) return;
    try {
      await timetableAPI.delete(scheduleId);
      mutateTimetable?.();
    } catch (error) {
      console.error("Failed to delete class schedule:", error);
      alert("Failed to delete class. Please try again.");
    }
  };

  // Handle create new block
  const handleCreateBlock = async (data: any) => {
    try {
      await timeblocksAPI.create(data);
      mutate();
      setShowQuickAdd(false);
      setSelectedCell(null);
    } catch (error) {
      console.error("Failed to create time block:", error);
      alert("Failed to create time block. Please try again.");
    }
  };

  // Handle update block
  const handleUpdateBlock = async (data: any) => {
    try {
      if (editingBlock) {
        await timeblocksAPI.update(editingBlock.id, data);
        mutate();
      }
      setShowQuickAdd(false);
      setEditingBlock(null);
    } catch (error) {
      console.error("Failed to update time block:", error);
      alert("Failed to update time block. Please try again.");
    }
  };

  // Handle file selection for ICS import
  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setSelectedFile(file);
      setStatusMsg(null);
    }
  };

  // Handle ICS file upload
  const handleICSUpload = async () => {
    if (!selectedFile) {
      setStatusMsg({ type: "error", text: "Please select a file first" });
      return;
    }

    setIsImporting(true);
    setStatusMsg(null);

    try {
      const formData = new FormData();
      formData.append("file", selectedFile);

      const API_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8000";
      const response = await fetch(`${API_URL}/timetable/import/ics`, {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({ detail: "Import failed" }));
        throw new Error(error.detail || "Import failed");
      }

      const result = await response.json();
      setStatusMsg({ type: "success", text: `Successfully imported ${result.imported_count} class(es)!` });
      setSelectedFile(null);
      if (fileInputRef.current) {
        fileInputRef.current.value = "";
      }
      mutateTimetable?.();
      setTimeout(() => {
        setShowImport(false);
        setStatusMsg(null);
      }, 2000);
    } catch (err: unknown) {
      const msg = err instanceof Error ? err.message : "Failed to import ICS file";
      setStatusMsg({ type: "error", text: msg });
    } finally {
      setIsImporting(false);
    }
  };

  // Handle NUSmods URL parsing
  const handleNUSmodsParse = async () => {
    if (!nusmodsUrl) {
      setStatusMsg({ type: "error", text: "Please enter a NUSmods URL" });
      return;
    }

    setIsImporting(true);
    setStatusMsg(null);

    try {
      const result = await timetableAPI.parseNUSmods("url", nusmodsUrl);

      if (result.success && result.schedules && result.schedules.length > 0) {
        setParsedClasses(result.schedules);
        setShowClassSelection(true);
        setStatusMsg({
          type: "success",
          text: `Found ${result.total_count} classes. Select which ones to import.`,
        });
      } else {
        setStatusMsg({
          type: "error",
          text: "No classes found in the NUSmods data. Please check your URL.",
        });
      }
    } catch (err: any) {
      console.error("Failed to parse NUSmods:", err);
      const msg = err.message || err.detail || "Failed to parse NUSmods data";
      setStatusMsg({ type: "error", text: msg });
    } finally {
      setIsImporting(false);
    }
  };

  // Get academic week number or fallback to calendar week
  const weekNumber = academicCalendar?.current_academic_week || Math.ceil((currentWeekStart.getDate() + 6) / 7);

  return (
    <div className={`min-h-screen font-sans antialiased transition-colors ${actualTheme === 'dark' ? 'bg-neutral-900 text-[#fdfcf8]' : 'bg-[#fdfcf8] text-[#1a1a1a]'}`}>
      <main className="w-full mx-auto px-4 md:px-6 py-4 md:py-6 max-w-[95%]">

        {/* Header Section - Compact Horizontal */}
        <div className="border-b-2 border-black dark:border-neutral-600 pb-2 mb-2">
          <div className="grid grid-cols-[1fr_auto_1fr] items-center">
            {/* Left spacer */}
            <div></div>

            {/* Center: Title and Date */}
            <div className="flex items-center gap-3 md:gap-4">
              <span className="bg-red-600 h-[2px] w-10 hidden md:block"></span>
              <span className="text-red-600 font-mono text-xs font-bold uppercase tracking-[0.2em]">
                {format(currentWeekStart, 'MMMM yyyy')}
              </span>
              <span className="text-black dark:text-white font-mono text-xs">•</span>
              <h2 className="text-2xl md:text-3xl font-serif font-black leading-none text-black dark:text-white">
                {academicCalendar ? `Academic Week ${weekNumber}` : `Week ${weekNumber}`}
              </h2>
              <span className="text-black dark:text-white font-mono text-xs">•</span>
              <p className="text-sm md:text-base font-serif text-black/60 dark:text-white/60">
                {format(currentWeekStart, 'MMM d')} — {format(weekEnd, 'MMM d')}
              </p>
            </div>

            {/* Right: Module Legend - Bigger */}
            {uniqueModules.length > 0 && (
              <div className="flex flex-wrap gap-2 justify-end">
                {uniqueModules.map((module) => (
                  <div
                    key={module.code}
                    className="flex items-center gap-2 px-3 py-1.5 border border-black dark:border-neutral-600 bg-white dark:bg-neutral-800"
                    title={module.name}
                  >
                    <div
                      className="w-3 h-3 rounded-full shrink-0"
                      style={{ backgroundColor: module.color }}
                    />
                    <span className="font-mono text-xs font-bold uppercase text-black dark:text-white">
                      {module.code}
                    </span>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Import Panel */}
        {showImport && (
          <div className="mb-4 border-2 border-black dark:border-neutral-600 bg-white dark:bg-neutral-800 p-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-bold text-lg text-black dark:text-white">Import Timetable</h3>
              <button
                onClick={() => setShowImport(false)}
                className="w-8 h-8 border border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600 transition-colors flex items-center justify-center"
              >
                <X size={16} />
              </button>
            </div>

            {/* Status Messages */}
            {statusMsg && (
              <div className={`mb-4 p-3 border-2 ${statusMsg.type === "error" ? "border-red-600 bg-red-50 dark:bg-red-950/20 text-red-900 dark:text-red-200" : "border-green-600 bg-green-50 dark:bg-green-950/20 text-green-900 dark:text-green-200"} font-mono text-sm`}>
                {statusMsg.text}
              </div>
            )}

            {/* Import Method Tabs */}
            <div className="flex gap-2 border-b border-black dark:border-neutral-600 mb-4">
              <button
                onClick={() => setImportTab("ics")}
                className={`px-4 py-2 text-sm font-bold border-b-2 transition-colors ${importTab === "ics"
                    ? "border-black dark:border-white text-black dark:text-white"
                    : "border-transparent text-black/60 dark:text-white/60 hover:text-black dark:hover:text-white"
                  }`}
              >
                ICS File
              </button>
              <button
                onClick={() => setImportTab("nusmods")}
                className={`px-4 py-2 text-sm font-bold border-b-2 transition-colors ${importTab === "nusmods"
                    ? "border-black dark:border-white text-black dark:text-white"
                    : "border-transparent text-black/60 dark:text-white/60 hover:text-black dark:hover:text-white"
                  }`}
              >
                NUSmods URL
              </button>
            </div>

            {/* ICS File Upload */}
            {importTab === "ics" && (
              <div className="space-y-4">
                <p className="text-sm text-black/70 dark:text-white/70 mb-2">
                  Export your timetable from NUSmods as an ICS file, then upload it here.
                </p>
                <div className="border-2 border-dashed border-black/30 dark:border-white/30 rounded-lg p-6 text-center hover:border-black dark:hover:border-white transition-colors">
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept=".ics"
                    disabled={isImporting}
                    onChange={handleFileSelect}
                    className="hidden"
                    id="ics-file-input"
                  />
                  <label
                    htmlFor="ics-file-input"
                    className="cursor-pointer flex flex-col items-center gap-2"
                  >
                    <File className="w-8 h-8 text-black/60 dark:text-white/60" />
                    {selectedFile ? (
                      <div className="text-sm">
                        <p className="font-bold text-black dark:text-white">{selectedFile.name}</p>
                        <p className="text-xs text-black/60 dark:text-white/60">{(selectedFile.size / 1024).toFixed(1)} KB</p>
                      </div>
                    ) : (
                      <p className="font-mono text-sm text-black/60 dark:text-white/60">Click to select an ICS file</p>
                    )}
                  </label>
                </div>

                <button
                  onClick={handleICSUpload}
                  disabled={!selectedFile || isImporting}
                  className="w-full px-6 py-3 bg-black text-white dark:bg-white dark:text-black font-bold uppercase text-xs tracking-widest hover:bg-neutral-800 dark:hover:bg-neutral-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  {isImporting ? (
                    <>
                      <Loader2 className="w-4 h-4 animate-spin" />
                      Importing...
                    </>
                  ) : (
                    <>
                      <Upload size={16} />
                      Import File
                    </>
                  )}
                </button>
              </div>
            )}

            {/* NUSmods URL Import */}
            {importTab === "nusmods" && (
              <div className="space-y-4">
                <p className="text-sm text-black/70 dark:text-white/70 mb-2">
                  Copy your NUSmods share URL and paste it below.
                </p>
                <div>
                  <label className="block text-sm font-bold mb-2 text-black dark:text-white">NUSmods Share URL</label>
                  <input
                    type="url"
                    placeholder="https://nusmods.com/timetable/sem-1/share?..."
                    value={nusmodsUrl}
                    onChange={(e) => setNusmodsUrl(e.target.value)}
                    className="w-full px-3 py-2 border border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white placeholder:text-black/40 dark:placeholder:text-white/40"
                  />
                </div>
                <button
                  onClick={handleNUSmodsParse}
                  disabled={!nusmodsUrl || isImporting}
                  className="w-full px-6 py-3 bg-black text-white dark:bg-white dark:text-black font-bold uppercase text-xs tracking-widest hover:bg-neutral-800 dark:hover:bg-neutral-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  {isImporting ? (
                    <>
                      <Loader2 className="w-4 h-4 animate-spin" />
                      Parsing...
                    </>
                  ) : (
                    <>
                      <Link2 size={16} />
                      Parse & Select Classes
                    </>
                  )}
                </button>
              </div>
            )}
          </div>
        )}

        {/* Loading State */}
        {isLoading ? (
          <div className="flex items-center justify-center py-20">
            <span className="font-mono text-xs font-bold uppercase tracking-widest text-black/40 dark:text-white/40">
              Loading weekly schedule...
            </span>
          </div>
        ) : (
          <>
            {/* Calendar Grid */}
            <WeeklyTimetable
              timeBlocks={timeBlocks || []}
              weekStart={currentWeekStart}
              onAddBlock={handleAddBlock}
              onEditBlock={handleEditBlock}
              onDeleteBlock={handleDeleteBlock}
              onDeleteSchedule={handleDeleteSchedule}
              classSchedules={classSchedules || []}
              showTimetable={showTimetable}
              isEditMode={isEditMode}
            />

            {/* Controls Section - Single Centered Row */}
            <div className="mt-4 border-t border-black/20 dark:border-white/20 pt-4">
              <div className="flex items-center justify-center gap-3 flex-wrap">
                {/* Week Navigation */}
                <button
                  onClick={goToPreviousWeek}
                  className="px-4 h-10 border border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600 font-bold uppercase text-xs tracking-widest transition-colors flex items-center gap-2"
                >
                  <ChevronLeft size={16} />
                  <span className="hidden sm:inline">Previous Week</span>
                </button>
                <button
                  onClick={goToToday}
                  className="px-5 h-10 border border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600 font-bold uppercase text-xs tracking-widest transition-colors"
                >
                  Today
                </button>
                <button
                  onClick={goToNextWeek}
                  className="px-4 h-10 border border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600 font-bold uppercase text-xs tracking-widest transition-colors flex items-center gap-2"
                >
                  <span className="hidden sm:inline">Next Week</span>
                  <ChevronRight size={16} />
                </button>

                <div className="w-px h-6 bg-black/20 dark:bg-white/20"></div>

                {/* Timetable Controls */}
                <button
                  onClick={handleToggleShowTimetable}
                  className={`px-4 h-10 border font-bold uppercase text-xs tracking-widest flex items-center gap-2 transition-colors ${showTimetable ? 'border-black dark:border-neutral-500 bg-black dark:bg-neutral-600 text-white dark:text-white' : 'border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600'}`}
                  title={showTimetable ? "Hide timetable" : "Show timetable"}
                >
                  {showTimetable ? <Eye size={16} /> : <EyeOff size={16} />}
                  <span className="hidden sm:inline">Timetable</span>
                </button>

                {/* Edit Mode Toggle */}
                <button
                  onClick={() => setIsEditMode(!isEditMode)}
                  className={`px-4 h-10 border font-bold uppercase text-xs tracking-widest flex items-center gap-2 transition-colors ${isEditMode ? 'border-red-600 dark:border-red-500 bg-red-600 dark:bg-red-600 text-white' : 'border-black dark:border-neutral-500 bg-white dark:bg-neutral-700 text-black dark:text-white hover:bg-black hover:text-white dark:hover:bg-neutral-600'}`}
                  title={isEditMode ? "Exit edit mode" : "Enter edit mode"}
                >
                  {isEditMode ? <Check size={16} /> : <Edit2 size={16} />}
                  <span className="hidden sm:inline">{isEditMode ? 'Done' : 'Edit'}</span>
                </button>

                {/* Meeting Finder */}
                <button
                  onClick={() => router.push('/planner/meeting-finder')}
                  className="px-4 h-10 border border-emerald-600 bg-emerald-50 dark:bg-emerald-950/20 text-emerald-700 dark:text-emerald-300 font-bold uppercase text-xs tracking-widest hover:bg-emerald-100 dark:hover:bg-emerald-950/40 transition-colors flex items-center gap-2"
                  title="Find meeting times with group"
                >
                  <Users size={16} />
                  <span className="hidden sm:inline">Meeting Finder</span>
                </button>

                <div className="w-px h-6 bg-black/20 dark:bg-white/20"></div>

                {/* Import Timetable */}
                <button
                  onClick={() => setShowImport(!showImport)}
                  className={`px-4 h-10 border font-bold uppercase text-xs tracking-widest flex items-center gap-2 transition-colors ${showImport ? 'border-blue-600 bg-blue-600 text-white' : 'border-blue-600 bg-blue-50 dark:bg-blue-950/20 text-blue-700 dark:text-blue-300 hover:bg-blue-100 dark:hover:bg-blue-950/40'}`}
                  title="Import timetable from NUSmods"
                >
                  <Upload size={16} />
                  <span className="hidden sm:inline">Import Timetable</span>
                </button>

                {/* Add Time Block */}
                <button
                  onClick={() => {
                    setSelectedCell({ day: new Date(), hour: new Date().getHours() });
                    setShowQuickAdd(true);
                  }}
                  className="px-5 h-10 bg-black text-white border border-black dark:bg-white dark:text-black dark:border-white font-bold uppercase text-xs tracking-widest hover:bg-neutral-800 dark:hover:bg-neutral-200 transition-colors flex items-center gap-2"
                >
                  <Plus size={16} />
                  <span>Add Time Block</span>
                </button>
              </div>
            </div>
          </>
        )}

        {/* Footer */}
        <footer className="max-w-[1400px] mx-auto px-4 md:px-6 py-6 border-t border-black/10 dark:border-white/10 text-center w-full mt-6">
          <div className="inline-block px-6 text-black/60 dark:text-white/60">
            <p className="font-mono text-[9px] uppercase tracking-[0.4em] opacity-60">Property of Academic Publishing Group © 2025</p>
          </div>
        </footer>
      </main>

      {/* Quick Add/Edit Modal */}
      {showQuickAdd && (
        <QuickAddModal
          isOpen={showQuickAdd}
          onClose={() => {
            setShowQuickAdd(false);
            setSelectedCell(null);
            setEditingBlock(null);
          }}
          onAdd={editingBlock ? handleUpdateBlock : handleCreateBlock}
          initialDay={selectedCell?.day}
          initialHour={selectedCell?.hour}
        />
      )}

      {/* Class Selection Modal for NUSmods */}
      <ClassSelectionModal
        isOpen={showClassSelection}
        onClose={() => {
          setShowClassSelection(false);
          setParsedClasses([]);
        }}
        classes={parsedClasses.map((cls, idx) => ({ ...cls, index: idx }))}
        onImport={async (selectedIndices) => {
          setIsImporting(true);
          try {
            await timetableAPI.importNUSmods("url", nusmodsUrl, 1, undefined, selectedIndices);
            mutateTimetable?.();
            setStatusMsg({ type: "success", text: "Timetable imported successfully!" });
            setShowImport(false);
            setNusmodsUrl("");
          } catch (error: any) {
            console.error("Failed to import:", error);
            setStatusMsg({ type: "error", text: error.message || "Failed to import timetable" });
          } finally {
            setIsImporting(false);
          }
        }}
      />
    </div>
  );
}
```

## Demo

![Planner Import Demo](/Users/oli/.gemini/antigravity/brain/bd39228d-1380-4195-93c2-4e8581631c8e/verify_planner_import_1770098385658.webp)

## How to Use

### Import via ICS File (Recommended)

1. Go to [NUSmods](https://nusmods.com)
2. Open your timetable
3. Click **Export** → **ICS**
4. On the planner page, click **Import Timetable**
5. Select the **ICS File** tab (default)
6. Click to upload your `.ics` file
7. Click **Import File**

### Import via NUSmods URL

1. On NUSmods, click **Share** to get your timetable URL
2. On the planner page, click **Import Timetable**
3. Select the **NUSmods URL** tab
4. Paste your share URL
5. Click **Parse & Select Classes**
6. Select which classes to import in the modal
7. Click **Import**

## Verification

✅ Page loads without errors  
✅ Import Timetable button appears in controls section  
✅ Import panel opens with ICS and NUSmods tabs  
✅ ICS file upload area functional  
✅ NUSmods URL input and parse button functional  
✅ Panel closes correctly  
✅ Imported classes appear in the weekly timetable view
